---
source_contract: "jaan-to/outputs/dev/contract/01-jaanify-mvp/api.yaml"
source_data_model: "jaan-to/outputs/backend/02-jaanify-data-model/02-data-model-jaanify-data-model.md"
source_task_breakdown: "jaan-to/outputs/backend/01-jaanify-mvp/01-be-tasks-jaanify-mvp.md"
framework: "Fastify v5"
database: "PostgreSQL 16 (Supabase)"
orm: "Prisma v6"
validation: "Zod + fastify-type-provider-zod v6.1"
total_files: 8
status: draft
created: 2026-02-09
last_updated: 2026-02-09
---

# Jaanify MVP — Backend Scaffold

> Generated by jaan.to backend-scaffold | 2026-02-09

---

## Executive Summary

Production-ready Fastify v5 backend scaffold for Jaanify AI Task Manager covering all 21 API endpoints, 7 Prisma models, Zod validation schemas, JWT auth middleware, and RFC 9457 error handling. Code follows ESM with `.js` extensions, `globalThis` PrismaClient singleton, and `fastify-type-provider-zod` v6.1 per research-informed best practices.

---

## Overview

| Field | Value |
|-------|-------|
| **Framework** | Fastify v5 |
| **Database** | PostgreSQL 16 (Supabase) |
| **ORM** | Prisma v6 |
| **Validation** | Zod + fastify-type-provider-zod v6.1 |
| **Auth** | JWT + Google OAuth2 + httpOnly refresh cookie |
| **Error Format** | RFC 9457 Problem Details |
| **Total Files** | 8 |
| **Generated** | 2026-02-09 |

## Tech Stack

### Backend
- **Language**: Node.js (v22.x LTS)
- **Framework**: Fastify v5
- **API Style**: REST + WebSocket for real-time
- **Auth**: JWT + OAuth2 (Google)

### Frontend
- **Language**: TypeScript (v5.4)
- **Framework**: React v19 with Next.js v15

---

## Architecture

### Project Structure

```
jaanify-api/
├── src/
│   ├── app.ts                          # Fastify app factory
│   ├── server.ts                       # Entry point + graceful shutdown
│   ├── lib/
│   │   ├── env.ts                      # Zod env validation (crash on bad config)
│   │   ├── prisma.ts                   # PrismaClient singleton (globalThis)
│   │   └── errors.ts                   # RFC 9457 helpers
│   ├── plugins/
│   │   └── middleware.ts               # Auth + error handler plugins
│   └── routes/
│       ├── auth/index.ts               # 4 auth endpoints
│       ├── users/index.ts              # 3 user endpoints
│       ├── tasks/index.ts              # 6 task endpoints
│       ├── daily-plans/index.ts        # 4 plan endpoints
│       ├── feedback/index.ts           # 1 feedback endpoint
│       └── guest-sessions/index.ts     # 2 guest endpoints
├── prisma/
│   └── schema.prisma                   # 7 models
├── package.json
├── tsconfig.json
├── .env.example
└── .gitignore
```

### Component Map

| Component | File | Purpose |
|-----------|------|---------|
| App Factory | `src/app.ts` | Plugin registration, route mounting, Zod compiler |
| Server Entry | `src/server.ts` | Env validation, listen, graceful shutdown |
| Env Validation | `src/lib/env.ts` | Zod schema for all environment variables |
| Prisma Client | `src/lib/prisma.ts` | Singleton via `globalThis` pattern |
| Auth Middleware | `src/plugins/middleware.ts` | JWT verification, public route bypass |
| Error Handler | `src/plugins/middleware.ts` | RFC 9457 with Zod/Prisma error mapping |
| Auth Routes | `src/routes/auth/index.ts` | Google OAuth, refresh, register, logout |
| User Routes | `src/routes/users/index.ts` | Profile CRUD |
| Task Routes | `src/routes/tasks/index.ts` | Task CRUD + AI parse |
| Plan Routes | `src/routes/daily-plans/index.ts` | AI plan generation + slot management |
| Feedback Routes | `src/routes/feedback/index.ts` | AI recommendation feedback |
| Guest Routes | `src/routes/guest-sessions/index.ts` | Anonymous 60-second onboarding |
| Prisma Schema | `prisma/schema.prisma` | 7 models with relations + indexes |
| Zod Schemas | *(in routes)* | Request/response validation per endpoint |

---

## Routes

| Method | Path | Handler | Schema | Description |
|--------|------|---------|--------|-------------|
| POST | `/v1/auth/google` | `authRoutes` | `googleAuthRequestSchema` → `authTokensSchema` | Google OAuth2 login |
| POST | `/v1/auth/refresh` | `authRoutes` | — → `authTokensSchema` | Refresh access token |
| POST | `/v1/auth/register` | `authRoutes` | `registerRequestSchema` → `authTokensSchema` | Guest → account |
| DELETE | `/v1/auth/logout` | `authRoutes` | — → 204 | Invalidate tokens |
| GET | `/v1/users/me` | `userRoutes` | — → `userResponseSchema` | Current user |
| PATCH | `/v1/users/me` | `userRoutes` | `userUpdateSchema` → `userResponseSchema` | Update profile |
| DELETE | `/v1/users/me` | `userRoutes` | — → 204 | Soft delete |
| GET | `/v1/tasks` | `taskRoutes` | `taskListQuerySchema` → paginated | List tasks |
| POST | `/v1/tasks` | `taskRoutes` | `taskCreateSchema` → `taskResponseSchema` | Create task |
| POST | `/v1/tasks/parse` | `taskRoutes` | `taskParseRequestSchema` → `taskParseResponseSchema` | AI parse |
| GET | `/v1/tasks/:id` | `taskRoutes` | `uuidParamSchema` → `taskResponseSchema` | Get task |
| PATCH | `/v1/tasks/:id` | `taskRoutes` | `taskUpdateSchema` → `taskResponseSchema` | Update task |
| DELETE | `/v1/tasks/:id` | `taskRoutes` | `uuidParamSchema` → 204 | Soft delete |
| GET | `/v1/daily-plans` | `dailyPlanRoutes` | `cursorParamSchema` → paginated | List plans |
| POST | `/v1/daily-plans/generate` | `dailyPlanRoutes` | — → `dailyPlanResponseSchema` | Generate AI plan |
| GET | `/v1/daily-plans/:id` | `dailyPlanRoutes` | `planIdParamSchema` → `dailyPlanResponseSchema` | Get plan |
| PATCH | `/v1/daily-plans/:id/slots/:sid` | `dailyPlanRoutes` | `dailyPlanSlotUpdateSchema` → `dailyPlanSlotSchema` | Update slot |
| POST | `/v1/feedback` | `feedbackRoutes` | `feedbackCreateSchema` → `feedbackResponseSchema` | Submit feedback |
| POST | `/v1/guest-sessions` | `guestSessionRoutes` | `guestSessionCreateSchema` → `guestSessionResponseSchema` | Create guest |
| GET | `/v1/guest-sessions/:anon_id` | `guestSessionRoutes` | `anonymousIdParamSchema` → `guestSessionResponseSchema` | Get guest |
| GET | `/v1/health` | inline | — → `{ status, timestamp }` | Health check |

---

## Data Model

7 Prisma models matching the data model specification:

| Model | Table | Relations | Soft Delete |
|-------|-------|-----------|-------------|
| User | `users` | → tasks, dailyPlans, userFeedback | Yes (`deletedAt`) |
| Task | `tasks` | → user, dailyPlanSlots, userFeedback | Yes (`deletedAt`) |
| DailyPlan | `daily_plans` | → user, slots, userFeedback | No |
| DailyPlanSlot | `daily_plan_slots` | → plan, task | No |
| UserFeedback | `user_feedback` | → user, task?, plan? | No |
| GuestSession | `guest_sessions` | standalone | TTL (7 days) |
| AuditLog | `audit_logs` | standalone (no FK) | No |

---

## Service Layer

Plain exported functions (no DI container — module caching is the singleton):

| Service | Methods | Key Logic |
|---------|---------|-----------|
| Auth | `authenticateWithGoogle`, `refreshAccessToken`, `registerFromGuest`, `invalidateRefreshToken` | OAuth exchange, JWT generation, guest migration via `$transaction` |
| Users | `getUserById`, `updateUser`, `softDeleteUser` | Profile CRUD with `deletedAt` filter |
| Tasks | `listTasks`, `createTask`, `getTask`, `updateTask`, `softDeleteTask`, `parseTaskInput` | Cursor pagination, AI enrichment on create, soft delete |
| DailyPlans | `listDailyPlans`, `generateDailyPlan`, `getDailyPlan`, `updatePlanSlot` | One-plan-per-day enforcement, `$transaction` for generation |
| Feedback | `createFeedback` | Simple insert with optional task/plan refs |
| Guests | `createGuestSession`, `getGuestSession` | UUID-based anonymous ID, 7-day TTL check |
| AuditLog | `createAuditLog` | Append-only logging |

---

## Middleware

### Auth Plugin
- JWT verification via `onRequest` hook
- Public path whitelist: `/auth/google`, `/auth/refresh`, `/auth/register`, `/guest-sessions`, `/health`, `/docs`
- Decorates `request.userId` and `request.jwtPayload`

### Error Handler (RFC 9457)
- `hasZodFastifySchemaValidationErrors(error)` → 400 with `errors[]`
- `isResponseSerializationError(error)` → 500 (server bug)
- `PrismaClientKnownRequestError`:
  - P2002 → 409 (unique constraint)
  - P2003 → 409 (foreign key)
  - P2025 → 404 (not found)
- Fallback → 500 with sanitized detail in production

---

## Configuration

### Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DATABASE_URL` | Yes | — | PostgreSQL connection string |
| `PORT` | No | 3000 | Server port |
| `HOST` | No | 0.0.0.0 | Server host |
| `NODE_ENV` | No | development | Environment |
| `LOG_LEVEL` | No | info | Pino log level |
| `CORS_ORIGIN` | No | http://localhost:3001 | CORS origin |
| `GOOGLE_CLIENT_ID` | Yes | — | Google OAuth2 client ID |
| `GOOGLE_CLIENT_SECRET` | Yes | — | Google OAuth2 client secret |
| `JWT_SECRET` | Yes | — | JWT signing key (min 32 chars) |
| `REFRESH_TOKEN_SECRET` | Yes | — | Refresh token key (min 32 chars) |
| `OPENAI_API_KEY` | Yes | — | OpenAI for AI parsing |
| `REDIS_URL` | No | — | Redis for caching/queues |

### Dependencies

**Production**: `fastify` ^5.7, `@fastify/autoload` ^6, `@fastify/cors` ^10, `@fastify/cookie` ^11, `@fastify/sensible` ^6, `@fastify/swagger` ^9, `@fastify/swagger-ui` ^5, `@prisma/client` ^6, `fastify-plugin` ^5, `fastify-type-provider-zod` ^6.1, `zod` ^3.24

**Dev**: `typescript` ^5.6, `@types/node` ^22, `fastify-tsconfig` ^2, `prisma` ^6, `tsx` ^4, `vitest` ^2, `eslint` ^9

---

## Scaffold Files

| # | File | Type | Description |
|---|------|------|-------------|
| 1 | `01-backend-scaffold-jaanify-mvp.md` | Doc | This file — architecture and setup guide |
| 2 | `01-backend-scaffold-routes-jaanify-mvp.ts` | Code | All 21 endpoint route handlers |
| 3 | `01-backend-scaffold-services-jaanify-mvp.ts` | Code | Service layer (7 service groups) |
| 4 | `01-backend-scaffold-schemas-jaanify-mvp.ts` | Code | Zod validation schemas for all endpoints |
| 5 | `01-backend-scaffold-middleware-jaanify-mvp.ts` | Code | Auth plugin + RFC 9457 error handler |
| 6 | `01-backend-scaffold-prisma-jaanify-mvp.prisma` | Schema | Prisma schema (7 models + relations + indexes) |
| 7 | `01-backend-scaffold-config-jaanify-mvp.ts` | Config | package.json, tsconfig, .env, app.ts, server.ts |
| 8 | `01-backend-scaffold-readme-jaanify-mvp.md` | Doc | Setup and run instructions |

---

## Quality Checks Passed

- [x] All 21 API endpoints from contract have route handlers
- [x] All 7 entities from data model have Prisma models with relations
- [x] Zod validation schemas generated for all request/response bodies
- [x] Error handler covers: Zod validation (400), Prisma (409/404), serialization (500), generic (500)
- [x] Service layer stubs exist for all business logic (auth, users, tasks, plans, feedback, guests, audit)
- [x] PrismaClient singleton via `globalThis` pattern
- [x] ESM imports with `.js` extensions
- [x] `fastify-type-provider-zod` v6.1 with `withTypeProvider<ZodTypeProvider>()` per route group
- [x] `hasZodFastifySchemaValidationErrors()` used (NOT `instanceof ZodError`)
- [x] `moduleResolution: "NodeNext"` (NOT `"bundler"`)
- [x] Env validation with Zod at startup (crash on invalid)
- [x] Graceful shutdown handling (SIGINT, SIGTERM)
- [x] No hardcoded secrets (all via env vars)
- [x] No `any` types in generated code
- [x] Cursor-based pagination matching API contract spec

---

## Metadata

| Field | Value |
|-------|-------|
| Generated | 2026-02-09 |
| Skill | jaan-to:backend-scaffold |
| Output Path | jaan-to/outputs/backend/scaffold/01-jaanify-mvp/ |
| Status | Draft |
