openapi: 3.1.0
info:
  title: Jaanify API
  version: 1.0.0
  description: |
    Jaanify is an AI-native task manager that shows its work. This API powers
    task management with transparent AI reasoning, daily plan generation, and
    voice-captured task input. All AI recommendations include reasoning data
    accessible through 3-tier Reasoning Cards.
  contact:
    name: Jaanify Team
    email: support@jaanify.com
  license:
    name: Proprietary

servers:
  - url: https://api.jaanify.com/v1
    description: Production
  - url: http://localhost:3000/v1
    description: Local development

tags:
  - name: Auth
    description: Authentication and session management
  - name: User
    description: Current user profile
  - name: Task
    description: Task CRUD with AI enrichment
  - name: DailyPlan
    description: AI-generated daily plans with reasoning
  - name: Feedback
    description: User feedback on AI recommendations
  - name: Guest
    description: Anonymous guest sessions

security:
  - BearerAuth: []

# ─────────────────────────────────────────
# COMPONENTS
# ─────────────────────────────────────────
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token (1-hour expiry). Obtain via /auth/google or /auth/refresh.

  # ── Base Schemas ────────────────────────
  schemas:
    Timestamps:
      type: object
      description: Standard timestamp fields included on all mutable resources.
      properties:
        created_at:
          type: string
          format: date-time
          description: When the resource was created.
          example: "2026-02-08T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          description: When the resource was last modified.
          example: "2026-02-08T14:22:00Z"

    ProblemDetails:
      type: object
      description: RFC 9457 Problem Details error response.
      required: [type, status, title]
      properties:
        type:
          type: string
          format: uri
          description: URI reference identifying the problem type.
          example: "https://api.jaanify.com/errors/not-found"
        status:
          type: integer
          description: HTTP status code.
          example: 404
        title:
          type: string
          description: Short human-readable summary.
          example: "Not Found"
        detail:
          type: ["string", "null"]
          description: Human-readable explanation specific to this occurrence.
          example: "Task with ID 123e4567-e89b-12d3-a456-426614174000 not found."
        instance:
          type: ["string", "null"]
          format: uri
          description: URI reference identifying this specific occurrence.

    ValidationProblemDetails:
      allOf:
        - $ref: '#/components/schemas/ProblemDetails'
        - type: object
          description: Validation error with field-level details.
          required: [errors]
          properties:
            errors:
              type: array
              description: List of validation errors.
              items:
                type: object
                required: [detail, pointer]
                properties:
                  detail:
                    type: string
                    description: What is wrong with the field.
                    example: "must be a valid email address"
                  pointer:
                    type: string
                    description: JSON Pointer to the invalid field.
                    example: "/email"

    PaginationMeta:
      type: object
      description: Cursor-based pagination metadata.
      required: [has_more, limit]
      properties:
        cursor:
          type: ["string", "null"]
          description: Opaque cursor for the next page. Null if no more results.
          example: "eyJpZCI6IjEyMyJ9"
        has_more:
          type: boolean
          description: Whether more results exist beyond this page.
          example: true
        limit:
          type: integer
          description: Number of items per page.
          minimum: 1
          maximum: 100
          example: 20

    # ── Auth Schemas ────────────────────────
    GoogleAuthRequest:
      type: object
      description: Google OAuth2 callback payload.
      required: [code, redirect_uri]
      properties:
        code:
          type: string
          description: OAuth2 authorization code from Google.
          example: "4/0AX4XfWg..."
        redirect_uri:
          type: string
          format: uri
          description: Redirect URI used in the OAuth flow.
          example: "https://jaanify.com/auth/callback"

    AuthTokens:
      type: object
      description: JWT token pair.
      required: [access_token, token_type, expires_in]
      properties:
        access_token:
          type: string
          description: JWT access token (1-hour expiry).
          example: "eyJhbGciOiJIUzI1NiIs..."
        refresh_token:
          type: string
          description: Refresh token (7-day expiry, httpOnly cookie).
          example: "dGhpcyBpcyBhIHJlZnJlc2g..."
        token_type:
          type: string
          description: Token type (always "Bearer").
          example: "Bearer"
        expires_in:
          type: integer
          description: Access token lifetime in seconds.
          example: 3600

    RegisterRequest:
      type: object
      description: Convert guest session to registered account.
      required: [anonymous_id, provider, code]
      properties:
        anonymous_id:
          type: string
          description: Guest session anonymous ID to migrate.
          minLength: 1
          maxLength: 64
          example: "anon_abc123def456"
        provider:
          type: string
          enum: [google, email]
          description: Auth provider for the new account.
          example: "google"
        code:
          type: string
          description: OAuth2 code or email verification token.
          example: "4/0AX4XfWg..."

    # ── User Schemas ────────────────────────
    User:
      type: object
      description: User profile.
      required: [id, auth_provider]
      properties:
        id:
          type: string
          format: uuid
          description: User unique identifier.
          example: "123e4567-e89b-12d3-a456-426614174000"
        email:
          type: ["string", "null"]
          format: email
          description: User email address. Null for guest-migrated accounts without email.
          maxLength: 255
          example: "jane@example.com"
        name:
          type: ["string", "null"]
          description: Display name.
          maxLength: 100
          example: "Jane Doe"
        avatar_url:
          type: ["string", "null"]
          format: uri
          description: Profile image URL (from OAuth provider).
          example: "https://lh3.googleusercontent.com/..."
        auth_provider:
          type: string
          enum: [google, email, guest]
          description: How the user authenticated.
          example: "google"
        preferences_json:
          type: object
          description: User preferences (theme, notification settings, AI model).
          example: {"theme": "light", "notifications": true}

    UserResponse:
      allOf:
        - $ref: '#/components/schemas/User'
        - $ref: '#/components/schemas/Timestamps'

    UserUpdate:
      type: object
      description: Updatable user profile fields.
      properties:
        name:
          type: ["string", "null"]
          maxLength: 100
          example: "Jane D."
        avatar_url:
          type: ["string", "null"]
          format: uri
          example: "https://example.com/avatar.jpg"
        preferences_json:
          type: object
          example: {"theme": "dark"}

    # ── Task Schemas ────────────────────────
    Task:
      type: object
      description: A task with AI-enriched metadata and reasoning.
      required: [id, user_id, title, status, priority_score]
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        user_id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        title:
          type: string
          description: Task title (extracted or user-provided).
          minLength: 1
          maxLength: 500
          example: "Call Sarah about the Johnson proposal"
        raw_input:
          type: ["string", "null"]
          description: Original user input before AI parsing.
          example: "Call Sarah about the Johnson proposal by Friday 2 PM"
        description:
          type: ["string", "null"]
          description: Optional detailed description.
          example: "Discuss pricing for Q2 contract renewal."
        deadline:
          type: ["string", "null"]
          format: date-time
          description: Task deadline (extracted by AI or set manually).
          example: "2026-02-14T14:00:00Z"
        category:
          type: ["string", "null"]
          description: Auto-detected or user-assigned category.
          maxLength: 100
          example: "Client work"
        priority_score:
          type: number
          format: double
          description: AI-computed priority (0.0 = lowest, 1.0 = highest).
          minimum: 0
          maximum: 1
          example: 0.82
        priority_override:
          type: ["integer", "null"]
          description: User-set manual priority (1-5, overrides AI score).
          minimum: 1
          maximum: 5
          example: null
        status:
          type: string
          enum: [active, completed, archived]
          description: Task lifecycle status.
          example: "active"
        reasoning_json:
          type: ["object", "null"]
          description: AI reasoning data for 3-tier Reasoning Cards.
          example:
            tier1: "High priority: deadline in 2h + blocks 3 tasks"
            factors:
              deadline: 0.3
              importance: 0.25
              dependencies: 0.2
              energy: 0.15
              time: 0.1
            confidence: 0.87
        energy_level:
          type: ["string", "null"]
          enum: [low, medium, high, null]
          description: Estimated energy required.
          example: "medium"
        estimated_minutes:
          type: ["integer", "null"]
          description: AI-estimated duration in minutes.
          minimum: 1
          example: 30
        completed_at:
          type: ["string", "null"]
          format: date-time
          example: null

    TaskResponse:
      allOf:
        - $ref: '#/components/schemas/Task'
        - $ref: '#/components/schemas/Timestamps'

    TaskCreate:
      type: object
      description: Create a new task (from raw input or structured fields).
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
          example: "Buy groceries for dinner tonight"
        raw_input:
          type: ["string", "null"]
          description: If provided, triggers AI parsing to enrich other fields.
          example: "Buy groceries for dinner tonight, remind me at 4 PM"
        description:
          type: ["string", "null"]
          example: null
        deadline:
          type: ["string", "null"]
          format: date-time
          example: "2026-02-08T16:00:00Z"
        category:
          type: ["string", "null"]
          maxLength: 100
          example: "Personal"
        energy_level:
          type: ["string", "null"]
          enum: [low, medium, high, null]
          example: "low"
        estimated_minutes:
          type: ["integer", "null"]
          minimum: 1
          example: 20

    TaskUpdate:
      type: object
      description: Update task fields (all optional for PATCH).
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
        description:
          type: ["string", "null"]
        deadline:
          type: ["string", "null"]
          format: date-time
        category:
          type: ["string", "null"]
          maxLength: 100
        status:
          type: string
          enum: [active, completed, archived]
        energy_level:
          type: ["string", "null"]
          enum: [low, medium, high, null]
        estimated_minutes:
          type: ["integer", "null"]
          minimum: 1
        priority_override:
          type: ["integer", "null"]
          minimum: 1
          maximum: 5

    TaskList:
      type: object
      description: Paginated list of tasks.
      required: [data, pagination]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TaskResponse'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'

    TaskParseRequest:
      type: object
      description: Parse natural language input without creating a task.
      required: [input]
      properties:
        input:
          type: string
          description: Natural language task description.
          minLength: 1
          maxLength: 2000
          example: "Call Sarah about the Johnson proposal by Friday 2 PM"

    TaskParseResponse:
      type: object
      description: AI-parsed task fields from natural language input.
      properties:
        title:
          type: string
          example: "Call Sarah about the Johnson proposal"
        deadline:
          type: ["string", "null"]
          format: date-time
          example: "2026-02-14T14:00:00Z"
        category:
          type: ["string", "null"]
          example: "Client work"
        energy_level:
          type: ["string", "null"]
          enum: [low, medium, high, null]
          example: "medium"
        estimated_minutes:
          type: ["integer", "null"]
          example: 15
        confidence:
          type: number
          description: AI confidence in parsing accuracy (0-1).
          minimum: 0
          maximum: 1
          example: 0.92
        reasoning:
          type: object
          description: Parsing reasoning for transparency.
          example:
            detected_deadline: "Friday 2 PM → 2026-02-14T14:00:00Z"
            detected_category: "Client work (keyword: proposal)"
            detected_energy: "medium (phone call, moderate effort)"

    # ── DailyPlan Schemas ────────────────────
    DailyPlan:
      type: object
      description: AI-generated daily plan with ordered task slots and reasoning.
      required: [id, user_id, date, status, reasoning_method]
      properties:
        id:
          type: string
          format: uuid
          example: "660e8400-e29b-41d4-a716-446655440001"
        user_id:
          type: string
          format: uuid
        date:
          type: string
          format: date
          description: The date this plan covers.
          example: "2026-02-08"
        status:
          type: string
          enum: [generating, active, completed]
          example: "active"
        reasoning_method:
          type: string
          enum: [ai, rule_based]
          description: How the plan was generated.
          example: "ai"
        generated_at:
          type: ["string", "null"]
          format: date-time
          example: "2026-02-08T06:00:00Z"
        slots:
          type: array
          description: Ordered task slots with reasoning.
          items:
            $ref: '#/components/schemas/DailyPlanSlot'

    DailyPlanResponse:
      allOf:
        - $ref: '#/components/schemas/DailyPlan'
        - $ref: '#/components/schemas/Timestamps'

    DailyPlanList:
      type: object
      required: [data, pagination]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/DailyPlanResponse'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'

    DailyPlanSlot:
      type: object
      description: A task positioned within a daily plan with AI reasoning.
      required: [id, plan_id, task_id, position, status]
      properties:
        id:
          type: string
          format: uuid
        plan_id:
          type: string
          format: uuid
        task_id:
          type: string
          format: uuid
        position:
          type: integer
          description: Order position in the plan (1-based).
          minimum: 1
          example: 1
        reasoning_json:
          type: ["object", "null"]
          description: Why this task is at this position.
          example:
            tier1: "#1 because: deadline in 2h + high energy match"
            factors:
              deadline_proximity: 0.35
              energy_match: 0.25
              dependency_chain: 0.20
              user_preference: 0.20
            confidence: 0.89
        status:
          type: string
          enum: [pending, completed, skipped]
          example: "pending"

    DailyPlanSlotUpdate:
      type: object
      description: Update a plan slot (reorder, complete, skip).
      properties:
        position:
          type: integer
          minimum: 1
          description: New position in the plan.
        status:
          type: string
          enum: [pending, completed, skipped]

    # ── Feedback Schema ────────────────────
    FeedbackCreate:
      type: object
      description: User feedback on AI recommendations.
      required: [feedback_type]
      properties:
        task_id:
          type: ["string", "null"]
          format: uuid
          description: Task this feedback relates to.
        plan_id:
          type: ["string", "null"]
          format: uuid
          description: Plan this feedback relates to.
        feedback_type:
          type: string
          enum: [priority_override, plan_override, not_now, wrong_category, other]
          description: Type of feedback.
          example: "not_now"
        reason:
          type: ["string", "null"]
          description: Optional explanation.
          maxLength: 500
          example: "I need to focus on client work first today."

    FeedbackResponse:
      type: object
      required: [id, user_id, feedback_type, created_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        task_id:
          type: ["string", "null"]
          format: uuid
        plan_id:
          type: ["string", "null"]
          format: uuid
        feedback_type:
          type: string
          enum: [priority_override, plan_override, not_now, wrong_category, other]
        reason:
          type: ["string", "null"]
        created_at:
          type: string
          format: date-time

    # ── Guest Session Schemas ────────────────
    GuestSessionCreate:
      type: object
      description: Create anonymous guest session for 60-second onboarding.
      properties:
        data_json:
          type: object
          description: Initial guest data (first task, preferences).
          example: {"first_task": "Buy groceries"}

    GuestSessionResponse:
      type: object
      required: [id, anonymous_id, expires_at, created_at]
      properties:
        id:
          type: string
          format: uuid
        anonymous_id:
          type: string
          description: Anonymous session identifier.
          maxLength: 64
          example: "anon_abc123def456"
        data_json:
          type: object
          example: {"first_task": "Buy groceries"}
        expires_at:
          type: string
          format: date-time
          description: Session expiry (7 days from creation).
          example: "2026-02-15T10:30:00Z"
        created_at:
          type: string
          format: date-time

  # ── Shared Parameters ────────────────────
  parameters:
    CursorParam:
      name: cursor
      in: query
      description: Opaque cursor for pagination. Pass the value from previous response's pagination.cursor.
      schema:
        type: string
    LimitParam:
      name: limit
      in: query
      description: Number of items per page (default 20, max 100).
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    TaskIdParam:
      name: task_id
      in: path
      required: true
      description: Task UUID.
      schema:
        type: string
        format: uuid
    PlanIdParam:
      name: plan_id
      in: path
      required: true
      description: Daily plan UUID.
      schema:
        type: string
        format: uuid
    SlotIdParam:
      name: slot_id
      in: path
      required: true
      description: Plan slot UUID.
      schema:
        type: string
        format: uuid

  # ── Shared Responses ────────────────────
  responses:
    BadRequest:
      description: Malformed request.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Unauthorized:
      description: Missing or invalid authentication token.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Forbidden:
      description: Authenticated but insufficient permissions.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    NotFound:
      description: Resource not found.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Conflict:
      description: Resource conflict (e.g., duplicate email).
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    ValidationError:
      description: Request body validation failed.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ValidationProblemDetails'
    TooManyRequests:
      description: Rate limit exceeded.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    InternalError:
      description: Unexpected server error.
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

# ─────────────────────────────────────────
# PATHS
# ─────────────────────────────────────────
paths:
  # ── Auth ────────────────────────────────
  /auth/google:
    post:
      operationId: authGoogle
      tags: [Auth]
      summary: Authenticate via Google OAuth2
      description: Exchange Google OAuth2 authorization code for JWT tokens.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GoogleAuthRequest'
      responses:
        '200':
          description: Authentication successful.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/refresh:
    post:
      operationId: authRefresh
      tags: [Auth]
      summary: Refresh access token
      description: Exchange refresh token (from httpOnly cookie) for new access token.
      security: []
      responses:
        '200':
          description: New token pair.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/register:
    post:
      operationId: authRegister
      tags: [Auth]
      summary: Convert guest session to registered account
      description: Migrates guest session data (tasks, preferences) to a new authenticated account.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Account created and guest data migrated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/logout:
    delete:
      operationId: authLogout
      tags: [Auth]
      summary: Logout and invalidate tokens
      description: Invalidates the current refresh token.
      responses:
        '204':
          description: Logged out successfully.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # ── User ────────────────────────────────
  /users/me:
    get:
      operationId: getMe
      tags: [User]
      summary: Get current user profile
      description: Returns the authenticated user's profile with preferences.
      responses:
        '200':
          description: User profile.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      operationId: updateMe
      tags: [User]
      summary: Update current user profile
      description: Update name, avatar, or preferences for the authenticated user.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: Updated user profile.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      operationId: deleteMe
      tags: [User]
      summary: Delete current user account
      description: Soft-deletes the user account. GDPR-compliant hard deletion occurs after 30-day grace period.
      responses:
        '204':
          description: Account scheduled for deletion.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # ── Tasks ────────────────────────────────
  /tasks:
    get:
      operationId: listTasks
      tags: [Task]
      summary: List user's tasks
      description: Returns paginated list of the authenticated user's active tasks.
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: status
          in: query
          schema:
            type: string
            enum: [active, completed, archived]
          description: Filter by task status.
        - name: category
          in: query
          schema:
            type: string
          description: Filter by category.
      responses:
        '200':
          description: Paginated task list.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      operationId: createTask
      tags: [Task]
      summary: Create a new task
      description: |
        Creates a task. If raw_input is provided, triggers AI parsing to auto-fill
        deadline, category, energy_level, and estimated_minutes with reasoning.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '201':
          description: Task created.
          headers:
            Location:
              schema:
                type: string
              description: URL of the created task.
              example: /v1/tasks/550e8400-e29b-41d4-a716-446655440000
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /tasks/parse:
    post:
      operationId: parseTask
      tags: [Task]
      summary: Parse natural language input (preview only)
      description: |
        AI-parses natural language task input without creating a task.
        Returns extracted fields and reasoning for real-time preview.
        Target: <100ms p95 response time.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskParseRequest'
      responses:
        '200':
          description: Parsed task fields with reasoning.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskParseResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /tasks/{task_id}:
    get:
      operationId: getTask
      tags: [Task]
      summary: Get a single task
      description: Returns task details including AI reasoning data.
      parameters:
        - $ref: '#/components/parameters/TaskIdParam'
      responses:
        '200':
          description: Task details.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      operationId: updateTask
      tags: [Task]
      summary: Update a task
      description: Update any task field. Setting status to "completed" also sets completed_at.
      parameters:
        - $ref: '#/components/parameters/TaskIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        '200':
          description: Updated task.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      operationId: deleteTask
      tags: [Task]
      summary: Soft-delete a task
      description: Marks the task as deleted (soft delete via deleted_at).
      parameters:
        - $ref: '#/components/parameters/TaskIdParam'
      responses:
        '204':
          description: Task deleted.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ── Daily Plans ────────────────────────────
  /daily-plans:
    get:
      operationId: listDailyPlans
      tags: [DailyPlan]
      summary: List user's daily plans
      description: Returns paginated list of daily plans, most recent first.
      parameters:
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Paginated plan list.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyPlanList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /daily-plans/generate:
    post:
      operationId: generateDailyPlan
      tags: [DailyPlan]
      summary: Generate today's AI daily plan
      description: |
        AI generates an optimized daily plan with reasoning for task ordering.
        Each slot includes a Reasoning Card (tier1 one-liner + factor weights).
        Target: <3s response time.
      responses:
        '201':
          description: Daily plan generated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyPlanResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Plan already exists for today.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /daily-plans/{plan_id}:
    get:
      operationId: getDailyPlan
      tags: [DailyPlan]
      summary: Get a daily plan with slots
      description: Returns the plan with all ordered task slots and their reasoning.
      parameters:
        - $ref: '#/components/parameters/PlanIdParam'
      responses:
        '200':
          description: Daily plan with slots.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyPlanResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /daily-plans/{plan_id}/slots/{slot_id}:
    patch:
      operationId: updatePlanSlot
      tags: [DailyPlan]
      summary: Update a plan slot
      description: Reorder a task within the plan or mark it as completed/skipped.
      parameters:
        - $ref: '#/components/parameters/PlanIdParam'
        - $ref: '#/components/parameters/SlotIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DailyPlanSlotUpdate'
      responses:
        '200':
          description: Updated slot.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DailyPlanSlot'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  # ── Feedback ────────────────────────────
  /feedback:
    post:
      operationId: createFeedback
      tags: [Feedback]
      summary: Submit feedback on AI recommendation
      description: Records user feedback that improves future AI recommendations.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackCreate'
      responses:
        '201':
          description: Feedback recorded.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalError'

  # ── Guest Sessions ────────────────────────
  /guest-sessions:
    post:
      operationId: createGuestSession
      tags: [Guest]
      summary: Create anonymous guest session
      description: |
        Creates a guest session for 60-second onboarding. No authentication required.
        Session expires after 7 days. Data migrates on registration via /auth/register.
      security: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GuestSessionCreate'
      responses:
        '201':
          description: Guest session created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuestSessionResponse'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /guest-sessions/{anonymous_id}:
    get:
      operationId: getGuestSession
      tags: [Guest]
      summary: Get guest session by anonymous ID
      description: Retrieves guest session data. Used to restore session on return visits.
      security: []
      parameters:
        - name: anonymous_id
          in: path
          required: true
          schema:
            type: string
            maxLength: 64
      responses:
        '200':
          description: Guest session.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GuestSessionResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
