---
prd_source: jaan-to/outputs/pm/prd/01-jaanify-mvp/01-prd-jaanify-mvp.md
feature: Jaanify MVP — Backend API
framework: Fastify v5 (Node.js v22)
slicing: vertical
total_tasks: 28
estimated_duration: 80-120 hours
status: draft
created: 2026-02-07
last_updated: 2026-02-07
---

# Backend Task Breakdown — Jaanify MVP

> Generated by jaan.to dev-be-task-breakdown | 2026-02-07

## Executive Summary

28 backend tasks organized into 7 vertical slices covering the full Jaanify MVP API: authentication, task CRUD with NLP parsing, AI prioritization with reasoning, daily plan generation, guest sessions, real-time WebSocket sync, and cross-cutting infrastructure. Critical path runs through 8 sequential tasks (~30-40h). Three parallel tracks enable concurrent development.

---

## Overview

| Field | Value |
|-------|-------|
| PRD | Jaanify MVP — The AI Task Manager That Shows Its Work |
| Framework | Fastify v5 + Prisma v6 + PostgreSQL 16 |
| Slicing | Vertical (feature-complete slices) |
| Total Tasks | 28 |
| Critical Path | 8 tasks (~30-40h) |
| Parallel Tracks | 3 independent streams |
| Estimated Duration | 80-120h (solo developer) |

---

## Tech Stack (from tech.md)

| Layer | Technology |
|-------|-----------|
| Runtime | Node.js v22 LTS |
| Framework | Fastify v5 |
| ORM | Prisma v6 |
| Database | PostgreSQL 16 (Supabase) |
| Cache / Queue | Redis 7 (Upstash) + BullMQ |
| Real-time | Socket.io v4 |
| Auth | JWT + next-auth + Google OAuth2 |
| AI | OpenAI SDK |
| Validation | zod |
| Search | Typesense |
| Testing | Vitest v3 |

---

## Entity Map

| Entity | Table | Tasks | Key Attributes |
|--------|-------|-------|----------------|
| User | users | 4 | id, email, name, avatar_url, auth_provider, preferences_json |
| Task | tasks | 6 | id, user_id, title, raw_input, deadline, category, priority_score, status, reasoning_json |
| TaskLabel | task_labels | — (inline) | id, task_id, label |
| DailyPlan | daily_plans | 3 | id, user_id, date, status, generated_at, reasoning_method |
| DailyPlanSlot | daily_plan_slots | — (inline) | id, plan_id, task_id, position, reasoning_json |
| UserFeedback | user_feedback | — (inline) | id, user_id, task_id, feedback_type, reason, created_at |
| GuestSession | guest_sessions | 2 | id, anonymous_id, data_json, expires_at |
| AuditLog | audit_logs | 1 | id, user_id, action, entity_type, entity_id, metadata, created_at |

---

## Tasks

### Slice 1: Foundation — Database Schema & Project Setup

---

#### [FND-001] Project Scaffold and Fastify Server Setup

**Size:** M (3-5h) | **Priority:** P0 | **Complexity:** Medium

**File(s):**
- `package.json`
- `tsconfig.json`
- `src/server.ts`
- `src/app.ts`
- `src/plugins/cors.ts`
- `src/plugins/swagger.ts`
- `.env.example`

**Dependencies:**
- blocked-by: none (starting point)

**Description:**
Initialize the Fastify v5 project with TypeScript, configure CORS, Swagger documentation, environment variable loading, and health check endpoint. This is the foundation all other tasks build on.

**Acceptance Criteria:**
- [ ] Fastify v5 server starts on configurable port
- [ ] Health check endpoint `GET /api/v1/health` returns 200
- [ ] CORS configured for allowed origins
- [ ] Swagger docs available at `/docs`
- [ ] Environment variables loaded via dotenv with validation

---

#### [FND-002] Prisma Schema and Database Migrations

**Size:** L (5-8h) | **Priority:** P0 | **Complexity:** High

**File(s):**
- `prisma/schema.prisma`
- `prisma/migrations/`
- `prisma/seed.ts`

**Dependencies:**
- blocked-by: [FND-001]

**Description:**
Define the complete Prisma schema for all entities (users, tasks, daily_plans, daily_plan_slots, user_feedback, guest_sessions, audit_logs) with relationships, indexes, and constraints. Generate and apply initial migration.

**Acceptance Criteria:**
- [ ] All 7 tables created with correct columns, types, and constraints
- [ ] Foreign key relationships established (tasks→users, daily_plan_slots→tasks, etc.)
- [ ] Indexes on: users.email (unique), tasks.user_id+status, tasks.deadline, daily_plans.user_id+date (unique), guest_sessions.anonymous_id (unique), guest_sessions.expires_at
- [ ] Soft delete support via `deleted_at` column on tasks and users
- [ ] Seed script creates test data for development
- [ ] Migration rolls back cleanly (`prisma migrate reset`)

**Data Model Notes:**
```yaml
table: users
columns:
  - name: id
    type: uuid
    default: gen_random_uuid()
  - name: email
    type: varchar(255)
    nullable: true
    unique: true
  - name: name
    type: varchar(100)
    nullable: true
  - name: avatar_url
    type: text
    nullable: true
  - name: auth_provider
    type: enum ['google', 'email', 'guest']
    default: 'guest'
  - name: preferences_json
    type: jsonb
    default: '{}'
  - name: deleted_at
    type: timestamp
    nullable: true
  - name: created_at
    type: timestamp
    default: now()
  - name: updated_at
    type: timestamp
    default: now()
indexes:
  - columns: [email]
    unique: true
    where: "deleted_at IS NULL"

table: tasks
columns:
  - name: id
    type: uuid
    default: gen_random_uuid()
  - name: user_id
    type: uuid
    foreign_key: users.id
  - name: title
    type: varchar(500)
  - name: raw_input
    type: text
    nullable: true
  - name: description
    type: text
    nullable: true
  - name: deadline
    type: timestamp
    nullable: true
  - name: category
    type: varchar(100)
    nullable: true
  - name: priority_score
    type: decimal(5,4)
    default: 0.5
  - name: priority_override
    type: integer
    nullable: true
  - name: status
    type: enum ['active', 'completed', 'archived']
    default: 'active'
  - name: reasoning_json
    type: jsonb
    nullable: true
  - name: energy_level
    type: enum ['low', 'medium', 'high']
    nullable: true
  - name: estimated_minutes
    type: integer
    nullable: true
  - name: completed_at
    type: timestamp
    nullable: true
  - name: deleted_at
    type: timestamp
    nullable: true
  - name: created_at
    type: timestamp
    default: now()
  - name: updated_at
    type: timestamp
    default: now()
indexes:
  - columns: [user_id, status]
    name: idx_tasks_user_status
  - columns: [deadline]
    name: idx_tasks_deadline
  - columns: [user_id, priority_score]
    name: idx_tasks_user_priority

table: daily_plans
columns:
  - name: id
    type: uuid
    default: gen_random_uuid()
  - name: user_id
    type: uuid
    foreign_key: users.id
  - name: date
    type: date
  - name: status
    type: enum ['generating', 'active', 'completed']
    default: 'generating'
  - name: reasoning_method
    type: enum ['ai', 'rule_based']
    default: 'ai'
  - name: generated_at
    type: timestamp
    nullable: true
  - name: created_at
    type: timestamp
    default: now()
  - name: updated_at
    type: timestamp
    default: now()
indexes:
  - columns: [user_id, date]
    unique: true

table: daily_plan_slots
columns:
  - name: id
    type: uuid
    default: gen_random_uuid()
  - name: plan_id
    type: uuid
    foreign_key: daily_plans.id
    on_delete: cascade
  - name: task_id
    type: uuid
    foreign_key: tasks.id
  - name: position
    type: integer
  - name: reasoning_json
    type: jsonb
    nullable: true
  - name: status
    type: enum ['pending', 'completed', 'skipped']
    default: 'pending'
  - name: created_at
    type: timestamp
    default: now()
  - name: updated_at
    type: timestamp
    default: now()

table: user_feedback
columns:
  - name: id
    type: uuid
    default: gen_random_uuid()
  - name: user_id
    type: uuid
    foreign_key: users.id
  - name: task_id
    type: uuid
    foreign_key: tasks.id
    nullable: true
  - name: plan_id
    type: uuid
    foreign_key: daily_plans.id
    nullable: true
  - name: feedback_type
    type: enum ['priority_override', 'plan_override', 'not_now', 'wrong_category', 'other']
  - name: reason
    type: text
    nullable: true
  - name: created_at
    type: timestamp
    default: now()

table: guest_sessions
columns:
  - name: id
    type: uuid
    default: gen_random_uuid()
  - name: anonymous_id
    type: varchar(64)
    unique: true
  - name: data_json
    type: jsonb
    default: '{}'
  - name: expires_at
    type: timestamp
  - name: created_at
    type: timestamp
    default: now()
indexes:
  - columns: [anonymous_id]
    unique: true
  - columns: [expires_at]
    name: idx_guest_sessions_expiry

table: audit_logs
columns:
  - name: id
    type: uuid
    default: gen_random_uuid()
  - name: user_id
    type: uuid
    nullable: true
  - name: action
    type: varchar(50)
  - name: entity_type
    type: varchar(50)
  - name: entity_id
    type: uuid
    nullable: true
  - name: metadata
    type: jsonb
    default: '{}'
  - name: created_at
    type: timestamp
    default: now()
indexes:
  - columns: [user_id, created_at]
    name: idx_audit_user_time
```

---

### Slice 2: Authentication & User Management

---

#### [AUTH-001] JWT Authentication Plugin

**Size:** M (3-5h) | **Priority:** P0 | **Complexity:** Medium

**File(s):**
- `src/plugins/auth.ts`
- `src/middleware/authenticate.ts`
- `src/middleware/optional-auth.ts`
- `src/schemas/auth.schema.ts`

**Dependencies:**
- blocked-by: [FND-001], [FND-002]

**Description:**
Implement JWT authentication as a Fastify plugin — token generation with 1-hour expiry, refresh token flow, and middleware for protected/optional-auth routes. Guest sessions bypass auth via optional-auth middleware.

**Acceptance Criteria:**
- [ ] JWT access tokens with 1-hour expiration
- [ ] Refresh tokens with 7-day expiration stored in httpOnly cookie
- [ ] `authenticate` middleware rejects invalid/expired tokens with 401
- [ ] `optional-auth` middleware attaches user if token present, continues if not
- [ ] Token payload includes: user_id, email, auth_provider

**Idempotency:**
- Type: Token-based (JWT inherently idempotent for reads)
- Refresh: Rate-limited to 1 per 5 seconds per user

**Security Checklist:**
- [ ] Tokens signed with RS256 or HS256 with strong secret
- [ ] Refresh token rotation on use (invalidate old token)
- [ ] Rate limiting on auth endpoints (5 req/min)
- [ ] No sensitive data in JWT payload

---

#### [AUTH-002] Google OAuth2 Integration

**Size:** M (3-5h) | **Priority:** P0 | **Complexity:** Medium

**File(s):**
- `src/routes/auth/oauth-google.ts`
- `src/services/oauth.service.ts`
- `src/schemas/auth.schema.ts` (extend)

**Dependencies:**
- blocked-by: [AUTH-001]

**Description:**
Implement Google OAuth2 login flow — redirect to Google consent, handle callback with authorization code, create or link user account, issue JWT tokens.

**Acceptance Criteria:**
- [ ] `GET /api/v1/auth/oauth/google` redirects to Google consent screen
- [ ] `GET /api/v1/auth/oauth/google/callback` exchanges code for tokens
- [ ] New users auto-created with Google profile data (name, email, avatar)
- [ ] Existing users (same email) linked to Google account
- [ ] JWT tokens returned after successful OAuth flow

**Error Scenarios:**
| Scenario | HTTP Code | Handling Strategy |
|----------|-----------|-------------------|
| Google API unreachable | 502 | Log error, return "Authentication service unavailable" |
| Invalid authorization code | 401 | Return "Invalid authentication, please try again" |
| Email already registered with different provider | 409 | Return "Email already registered — sign in with {provider}" |

---

#### [AUTH-003] User Profile and Preferences

**Size:** S (2-3h) | **Priority:** P1 | **Complexity:** Low

**File(s):**
- `src/routes/users/me.ts`
- `src/services/user.service.ts`
- `src/schemas/user.schema.ts`

**Dependencies:**
- blocked-by: [AUTH-001]

**Description:**
Endpoints for retrieving and updating user profile and preferences (Focus Mode default, reasoning tier preference, notification settings, high-contrast mode).

**Acceptance Criteria:**
- [ ] `GET /api/v1/users/me` returns user profile with preferences
- [ ] `PATCH /api/v1/users/me/preferences` updates preferences_json
- [ ] Preferences validated with zod schema
- [ ] Returns 401 for unauthenticated requests

---

### Slice 3: Task Management — CRUD & NLP Parsing

---

#### [TASK-001] Task CRUD Routes

**Size:** M (3-5h) | **Priority:** P0 | **Complexity:** Medium

**File(s):**
- `src/routes/tasks/index.ts`
- `src/routes/tasks/[id].ts`
- `src/services/task.service.ts`
- `src/schemas/task.schema.ts`

**Dependencies:**
- blocked-by: [FND-002], [AUTH-001]

**Description:**
Core task CRUD endpoints: create, list (with filtering/sorting), get by ID, update, soft delete, complete, and archive. All routes require authentication, with task ownership enforced.

**Acceptance Criteria:**
- [ ] `POST /api/v1/tasks` creates task, returns enriched task object
- [ ] `GET /api/v1/tasks` lists user's active tasks with cursor pagination (25/page)
- [ ] `GET /api/v1/tasks/:id` returns task with reasoning data
- [ ] `PATCH /api/v1/tasks/:id` updates task fields
- [ ] `DELETE /api/v1/tasks/:id` soft-deletes (sets deleted_at)
- [ ] `PATCH /api/v1/tasks/:id/complete` sets status=completed and completed_at
- [ ] All routes enforce ownership (user can only access own tasks)

**Idempotency:**
- Type: Idempotency key header for POST (X-Idempotency-Key)
- Storage: Redis with 24h TTL
- Duplicate: Return cached response with 200

**Error Scenarios:**
| Scenario | HTTP Code | Handling Strategy |
|----------|-----------|-------------------|
| Task not found | 404 | Return "Task not found" |
| Task belongs to another user | 403 | Return "Forbidden" (don't leak existence) |
| Invalid input | 400 | Return zod validation errors |

**Security Checklist:**
- [ ] Input validation via zod schemas
- [ ] Ownership check on every task operation
- [ ] Rate limiting: 60 req/min
- [ ] SQL injection prevention via Prisma parameterized queries

---

#### [TASK-002] NLP Task Parsing Endpoint

**Size:** M (3-5h) | **Priority:** P0 | **Complexity:** High

**File(s):**
- `src/routes/tasks/parse.ts`
- `src/services/ai/parse.service.ts`
- `src/schemas/parse.schema.ts`

**Dependencies:**
- blocked-by: [TASK-001]

**Description:**
Real-time NLP parsing endpoint that accepts raw text input and returns structured fields (title, deadline, category, priority) using OpenAI GPT-4o-mini, along with reasoning data for the Tier 1 Reasoning Card.

**Acceptance Criteria:**
- [ ] `POST /api/v1/tasks/parse` accepts `{ text: string }` and returns parsed fields
- [ ] Response includes: title, deadline, category, priority, reasoning_text
- [ ] Response time <100ms p95 (debounced on frontend, backend processes single request)
- [ ] Supports optional-auth (guests can parse tasks)
- [ ] When AI unavailable, returns `{ fallback: true, title: raw_text }` with empty enrichment

**Idempotency:**
- Type: Cache identical input text in Redis (30s TTL)
- Key: `parse:{sha256(text)}`

**Error Scenarios:**
| Scenario | HTTP Code | Handling Strategy |
|----------|-----------|-------------------|
| OpenAI API timeout (>5s) | 200 | Return fallback with raw text as title |
| OpenAI rate limit | 200 | Return fallback, queue for retry |
| Input exceeds 500 chars | 400 | Return validation error |

**Reliability Notes:**
- Queue: Not queued (synchronous for real-time UX)
- Timeout: 5s for OpenAI call
- Circuit breaker: Open after 5 consecutive failures, half-open after 30s
- Fallback: Return raw text as title with empty enrichment fields

---

#### [TASK-003] Task Labels Management

**Size:** S (1-2h) | **Priority:** P2 | **Complexity:** Low

**File(s):**
- `src/routes/tasks/labels.ts`
- `src/schemas/label.schema.ts`

**Dependencies:**
- blocked-by: [TASK-001]
- parallel-with: [TASK-002]

**Description:**
CRUD for task labels — add labels to tasks, remove labels, list user's labels. Labels are stored as a related table for flexibility.

**Acceptance Criteria:**
- [ ] `POST /api/v1/tasks/:id/labels` adds label to task
- [ ] `DELETE /api/v1/tasks/:id/labels/:label` removes label
- [ ] `GET /api/v1/labels` lists all labels used by the user (deduplicated)
- [ ] Labels are case-insensitive (stored lowercase)

---

### Slice 4: AI Prioritization & Reasoning

---

#### [AI-001] Task Prioritization Service

**Size:** L (5-8h) | **Priority:** P0 | **Complexity:** High

**File(s):**
- `src/services/ai/prioritize.service.ts`
- `src/routes/tasks/prioritize.ts`
- `src/schemas/prioritize.schema.ts`

**Dependencies:**
- blocked-by: [TASK-001]

**Description:**
AI-powered task prioritization endpoint — accepts a user's task list, sends to OpenAI for priority scoring with reasoning, stores results. Includes rule-based fallback when AI unavailable. Factor weights: deadline (0.3), importance (0.25), dependencies (0.2), energy (0.15), time_fit (0.1).

**Acceptance Criteria:**
- [ ] `POST /api/v1/tasks/prioritize` returns ordered task list with scores and reasoning_json per task
- [ ] Each task in response includes: priority_score (0.0-1.0), factors array with weights, reasoning_text
- [ ] Response time <3s for up to 50 tasks
- [ ] Rule-based fallback calculates score from: `(deadline_urgency * 0.4) + (user_importance * 0.3) + (dependency_count * 0.2) + (energy_match * 0.1)`
- [ ] Fallback response includes `reasoning_method: "rule_based"`
- [ ] Prioritized scores stored on task records in database

**Idempotency:**
- Type: Cache result in Redis (5-minute TTL, invalidated on task changes)
- Key: `prioritize:{user_id}:{task_hash}`

**Error Scenarios:**
| Scenario | HTTP Code | Handling Strategy |
|----------|-----------|-------------------|
| OpenAI timeout (>5s) | 200 | Use rule-based fallback, flag reasoning_method |
| OpenAI rate limit | 200 | Use rule-based fallback, retry in background |
| No tasks to prioritize | 200 | Return empty array |

**Reliability Notes:**
- Timeout: 5s for OpenAI
- Circuit breaker: Open after 3 failures, half-open after 60s
- Fallback: Rule-based scoring (always available, no external dependency)

---

#### [AI-002] Priority Override with Feedback

**Size:** S (2-3h) | **Priority:** P1 | **Complexity:** Medium

**File(s):**
- `src/routes/tasks/override.ts`
- `src/services/feedback.service.ts`
- `src/schemas/feedback.schema.ts`

**Dependencies:**
- blocked-by: [AI-001]

**Description:**
Endpoint for users to override AI priority with structured feedback. Stores feedback for AI learning, triggers re-prioritization of remaining tasks.

**Acceptance Criteria:**
- [ ] `PATCH /api/v1/tasks/:id/priority` accepts `{ position: number, feedback_type: string, reason?: string }`
- [ ] Override applied immediately (optimistic) with re-prioritization triggered async
- [ ] Feedback stored in user_feedback table
- [ ] Re-prioritization completes within 3s
- [ ] Feedback types: "deadline_changed", "more_urgent", "less_important", "context_missing", "other"

---

#### [AI-003] Reasoning Data Retrieval

**Size:** S (1-2h) | **Priority:** P1 | **Complexity:** Low

**File(s):**
- `src/routes/tasks/reasoning.ts`
- `src/schemas/reasoning.schema.ts`

**Dependencies:**
- blocked-by: [AI-001]
- parallel-with: [AI-002]

**Description:**
Endpoints for retrieving full reasoning data for Tier 2 and Tier 3 Reasoning Card views. Tier 1 data is inline on task objects; Tier 3 requires a separate fetch for full reasoning chain.

**Acceptance Criteria:**
- [ ] `GET /api/v1/tasks/:id/reasoning` returns full reasoning data (Tier 2 + Tier 3)
- [ ] Response includes: factors array with weights, confidence percentage, data_points array, full_reasoning_chain
- [ ] For rule-based recommendations, returns simplified reasoning without confidence %
- [ ] Cached in Redis (5-minute TTL)

---

### Slice 5: Daily Plan

---

#### [PLAN-001] Daily Plan Generation

**Size:** L (5-8h) | **Priority:** P0 | **Complexity:** High

**File(s):**
- `src/routes/plan/generate.ts`
- `src/routes/plan/today.ts`
- `src/services/ai/plan.service.ts`
- `src/schemas/plan.schema.ts`

**Dependencies:**
- blocked-by: [AI-001]

**Description:**
Generate AI-powered daily plan — fetches user's active tasks, sends to OpenAI for ordering with per-slot reasoning, stores plan with slots. Includes rule-based fallback. Supports "on demand" generation and cached retrieval.

**Acceptance Criteria:**
- [ ] `POST /api/v1/plan/generate` creates a new daily plan with AI ordering
- [ ] `GET /api/v1/plan/today` returns today's plan (or 404 if none)
- [ ] Plan includes: ordered task slots, each with position and reasoning_json
- [ ] Maximum 10 tasks per daily plan (cognitive load limit)
- [ ] Generation completes within 3s
- [ ] Only one plan per user per day (unique constraint)
- [ ] Rule-based fallback uses same scoring as [AI-001]

**Idempotency:**
- Type: Database unique constraint (user_id + date)
- Duplicate: Return existing plan with 200

**Error Scenarios:**
| Scenario | HTTP Code | Handling Strategy |
|----------|-----------|-------------------|
| OpenAI timeout | 200 | Generate rule-based plan, flag method |
| No active tasks | 200 | Return empty plan with message |
| Plan already exists for today | 200 | Return existing plan |

---

#### [PLAN-002] Plan Slot Override and Completion

**Size:** M (2-4h) | **Priority:** P1 | **Complexity:** Medium

**File(s):**
- `src/routes/plan/slots.ts`
- `src/services/plan-slot.service.ts`

**Dependencies:**
- blocked-by: [PLAN-001]

**Description:**
Endpoints for overriding plan slot positions (drag-to-reorder), marking slots as completed/skipped, and triggering re-ordering of remaining slots.

**Acceptance Criteria:**
- [ ] `PATCH /api/v1/plan/slots/:id` updates position or status
- [ ] Completing a slot triggers re-ordering of remaining slots
- [ ] Skipping a slot moves task to end with updated reasoning
- [ ] Feedback stored in user_feedback table
- [ ] Re-ordering completes within 3s

---

### Slice 6: Guest Sessions

---

#### [GUEST-001] Guest Session Management

**Size:** M (3-5h) | **Priority:** P0 | **Complexity:** Medium

**File(s):**
- `src/routes/auth/guest.ts`
- `src/services/guest.service.ts`
- `src/middleware/guest-or-auth.ts`
- `src/schemas/guest.schema.ts`

**Dependencies:**
- blocked-by: [FND-002], [AUTH-001]

**Description:**
Create and manage anonymous guest sessions — generate guest UUID, create temporary user record with auth_provider='guest', set 7-day expiration. Guest users can create tasks and use NLP parsing without registration.

**Acceptance Criteria:**
- [ ] `POST /api/v1/auth/guest` creates anonymous session with 7-day expiry
- [ ] Returns JWT token with guest user_id
- [ ] Guest users can create, list, update, and delete tasks
- [ ] Guest sessions automatically expire after 7 days
- [ ] Expired sessions return 401 with "Guest session expired — create an account to continue"

**Security Checklist:**
- [ ] Rate limiting on guest creation: 3 per IP per hour
- [ ] Guest tokens clearly flagged in payload (auth_provider: 'guest')
- [ ] No access to premium features from guest tokens

---

#### [GUEST-002] Guest-to-User Migration

**Size:** M (3-5h) | **Priority:** P1 | **Complexity:** High

**File(s):**
- `src/routes/auth/migrate-guest.ts`
- `src/services/migration.service.ts`

**Dependencies:**
- blocked-by: [GUEST-001], [AUTH-002]

**Description:**
Migrate guest session data to a registered user account — transfer all tasks, reasoning data, and feedback from the guest user record to the newly created authenticated user. Must be atomic (all-or-nothing).

**Acceptance Criteria:**
- [ ] `POST /api/v1/auth/migrate-guest` accepts guest_token and new auth credentials
- [ ] All tasks transferred: ownership updated from guest_id to user_id
- [ ] All user_feedback records transferred
- [ ] Daily plans transferred
- [ ] Guest session record deleted after successful migration
- [ ] Transaction: migration is atomic — all records transfer or none do
- [ ] Returns new JWT tokens for the authenticated user

**Error Scenarios:**
| Scenario | HTTP Code | Handling Strategy |
|----------|-----------|-------------------|
| Guest session expired | 410 | Return "Guest session expired" |
| Email already registered | 409 | Return "Email already exists — sign in instead" |
| Migration partially fails | 500 | Rollback transaction, log error, return "Migration failed — try again" |

---

### Slice 7: Real-Time & Infrastructure

---

#### [WS-001] WebSocket Server Setup

**Size:** M (3-5h) | **Priority:** P1 | **Complexity:** Medium

**File(s):**
- `src/plugins/websocket.ts`
- `src/websocket/handlers.ts`
- `src/websocket/rooms.ts`

**Dependencies:**
- blocked-by: [FND-001], [AUTH-001]

**Description:**
Socket.io v4 integration with Fastify — authenticated WebSocket connections, user-scoped rooms, and event broadcasting for task updates and plan changes.

**Acceptance Criteria:**
- [ ] Socket.io attached to Fastify server
- [ ] JWT authentication on WebSocket handshake
- [ ] Each authenticated user joins their own room (`user:{user_id}`)
- [ ] Events: `task:created`, `task:updated`, `task:deleted`, `task:completed`, `plan:updated`
- [ ] Broadcast to user's room when any task or plan mutation occurs
- [ ] Connection state tracked for online/offline detection

---

#### [WS-002] Real-Time Event Broadcasting from Routes

**Size:** S (2-3h) | **Priority:** P1 | **Complexity:** Low

**File(s):**
- `src/services/broadcast.service.ts`
- Modify: `src/services/task.service.ts`
- Modify: `src/services/plan-slot.service.ts`

**Dependencies:**
- blocked-by: [WS-001], [TASK-001], [PLAN-001]

**Description:**
Integrate WebSocket broadcasting into existing task and plan services — emit events after successful mutations so connected clients receive real-time updates within <500ms.

**Acceptance Criteria:**
- [ ] Task CRUD operations emit corresponding WebSocket events
- [ ] Plan generation and slot updates emit `plan:updated`
- [ ] Events delivered to client within <500ms of mutation
- [ ] Events include full updated object (not just ID)
- [ ] No broadcast for failed operations

---

#### [INFRA-001] Rate Limiting Plugin

**Size:** S (1-2h) | **Priority:** P1 | **Complexity:** Low

**File(s):**
- `src/plugins/rate-limit.ts`

**Dependencies:**
- blocked-by: [FND-001]
- parallel-with: [FND-002]

**Description:**
Configure Fastify rate-limit plugin with Redis backing (Upstash) — different limits per route category.

**Acceptance Criteria:**
- [ ] Default: 60 req/min for authenticated routes
- [ ] Auth endpoints: 5 req/min per IP
- [ ] Guest creation: 3 req/hour per IP
- [ ] AI endpoints (parse, prioritize, plan): 20 req/min
- [ ] Rate limit headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`
- [ ] Returns 429 with retry-after header when exceeded

---

#### [INFRA-002] Error Handling and RFC 7807 Responses

**Size:** S (2-3h) | **Priority:** P0 | **Complexity:** Low

**File(s):**
- `src/plugins/error-handler.ts`
- `src/utils/errors.ts`

**Dependencies:**
- blocked-by: [FND-001]
- parallel-with: [FND-002]

**Description:**
Global error handler returning RFC 7807 Problem Details JSON. Custom error classes for domain errors (NotFound, Forbidden, Validation, RateLimit, ServiceUnavailable).

**Acceptance Criteria:**
- [ ] All error responses follow RFC 7807 format: `{ type, title, status, detail, instance }`
- [ ] Validation errors include field-level details
- [ ] Unhandled exceptions return 500 without leaking stack traces
- [ ] All errors logged with correlation ID
- [ ] Custom error classes: AppError, NotFoundError, ForbiddenError, ValidationError

---

#### [INFRA-003] Request Logging and Audit Trail

**Size:** S (2-3h) | **Priority:** P1 | **Complexity:** Low

**File(s):**
- `src/plugins/logger.ts`
- `src/services/audit.service.ts`

**Dependencies:**
- blocked-by: [FND-002]

**Description:**
Structured JSON request logging with correlation IDs. Audit log service that records significant actions (task creation, deletion, account migration, priority overrides) to the audit_logs table.

**Acceptance Criteria:**
- [ ] Every request logged with: method, path, status, duration_ms, correlation_id
- [ ] Audit events recorded for: task.created, task.deleted, task.completed, auth.registered, auth.guest_migrated, priority.overridden
- [ ] Audit records include: user_id, action, entity_type, entity_id, metadata
- [ ] No PII logged in request logs (sanitize email, tokens)

---

#### [INFRA-004] BullMQ Job Queue Setup

**Size:** M (3-5h) | **Priority:** P1 | **Complexity:** Medium

**File(s):**
- `src/plugins/queue.ts`
- `src/jobs/cleanup-expired-guests.job.ts`
- `src/jobs/retry-ai-enrichment.job.ts`

**Dependencies:**
- blocked-by: [FND-001], [GUEST-001]

**Description:**
BullMQ job queue with Redis backing for background tasks: expired guest session cleanup (daily cron), deferred AI enrichment retries when OpenAI was unavailable, and future background jobs.

**Acceptance Criteria:**
- [ ] BullMQ connected to Upstash Redis
- [ ] `cleanup-expired-guests` runs daily, deletes sessions past expires_at
- [ ] `retry-ai-enrichment` retries NLP parsing for tasks created during AI outage
- [ ] Jobs configurable: retries (3), exponential backoff (30s, 2m, 8m), timeout (60s)
- [ ] Dead letter queue captures permanently failed jobs
- [ ] Queue health endpoint: `GET /api/v1/admin/queue-health`

**Reliability Notes:**
- Queue: `default` (standard), `ai` (AI-related retries)
- Tries: 3
- Backoff: exponential (30s, 2m, 8m)
- Timeout: 60s
- Dead letter: `failed-jobs` queue with no auto-retry

---

#### [INFRA-005] OpenAI Circuit Breaker Service

**Size:** S (2-3h) | **Priority:** P0 | **Complexity:** Medium

**File(s):**
- `src/services/ai/openai-client.ts`
- `src/services/ai/circuit-breaker.ts`

**Dependencies:**
- blocked-by: [FND-001]
- parallel-with: [FND-002]

**Description:**
Centralized OpenAI client wrapper with circuit breaker pattern — prevents cascade failures when OpenAI is down. Tracks failure count, opens circuit after threshold, provides half-open probe mechanism.

**Acceptance Criteria:**
- [ ] Circuit opens after 5 consecutive OpenAI failures
- [ ] Open circuit returns fallback immediately (no API call)
- [ ] Half-open state after 30s allows single probe request
- [ ] Successful probe closes circuit
- [ ] All AI services (parse, prioritize, plan) use this client
- [ ] Circuit state stored in Redis for multi-instance awareness

---

### Slice 8: Testing

---

#### [TEST-001] Test Infrastructure and Factories

**Size:** M (3-5h) | **Priority:** P1 | **Complexity:** Medium

**File(s):**
- `src/test/setup.ts`
- `src/test/factories/user.factory.ts`
- `src/test/factories/task.factory.ts`
- `src/test/factories/plan.factory.ts`
- `src/test/helpers/auth.helper.ts`
- `vitest.config.ts`

**Dependencies:**
- blocked-by: [FND-002]

**Description:**
Test infrastructure: Vitest configuration, test database setup/teardown, factory functions for creating test users/tasks/plans, and auth helper for generating test JWT tokens.

**Acceptance Criteria:**
- [ ] Vitest configured with test database (separate from dev)
- [ ] Database reset between test suites
- [ ] Factory functions for: User, Task, DailyPlan, GuestSession
- [ ] Auth helper generates valid JWT tokens for test users
- [ ] Test coverage reporting configured (>=80% target)

---

#### [TEST-002] Integration Tests — Task CRUD and NLP

**Size:** M (3-5h) | **Priority:** P1 | **Complexity:** Medium

**File(s):**
- `src/test/routes/tasks.test.ts`
- `src/test/routes/tasks-parse.test.ts`

**Dependencies:**
- blocked-by: [TEST-001], [TASK-001], [TASK-002]

**Description:**
Integration tests for task CRUD endpoints and NLP parsing — happy paths, validation errors, ownership enforcement, pagination, and AI fallback behavior.

**Acceptance Criteria:**
- [ ] Tests for: create, list, get, update, delete, complete task
- [ ] Tests for: NLP parse with valid input, empty input, AI fallback
- [ ] Tests for: ownership enforcement (user A can't access user B's tasks)
- [ ] Tests for: cursor pagination correctness
- [ ] Tests for: soft delete (deleted tasks excluded from list)
- [ ] Minimum 15 test cases

---

#### [TEST-003] Integration Tests — Auth, Plan, and Guest

**Size:** M (3-5h) | **Priority:** P1 | **Complexity:** Medium

**File(s):**
- `src/test/routes/auth.test.ts`
- `src/test/routes/plan.test.ts`
- `src/test/routes/guest.test.ts`

**Dependencies:**
- blocked-by: [TEST-001], [AUTH-001], [PLAN-001], [GUEST-001]

**Description:**
Integration tests for auth flows (JWT, refresh, OAuth mock), daily plan generation and slot management, and guest session lifecycle including migration.

**Acceptance Criteria:**
- [ ] Tests for: login, token refresh, expired token rejection
- [ ] Tests for: plan generation, slot override, slot completion
- [ ] Tests for: guest session creation, task creation as guest, session expiry
- [ ] Tests for: guest-to-user migration (atomic transfer)
- [ ] Tests for: rate limiting on auth endpoints
- [ ] Minimum 15 test cases

---

## Dependency Graph

```
CRITICAL PATH (Sequential)
══════════════════════════
[FND-001] → [FND-002] → [AUTH-001] → [TASK-001] → [AI-001] → [PLAN-001] → [WS-002] → [TEST-002]
 Scaffold     Schema      JWT Auth     Task CRUD   AI Priority  Daily Plan   Broadcast    Tests
  M(3-5h)    L(5-8h)     M(3-5h)      M(3-5h)     L(5-8h)     L(5-8h)     S(2-3h)     M(3-5h)

Total critical path: ~30-40 hours

PARALLEL TRACKS
═══════════════

Track A (after FND-001):
  [INFRA-001] Rate Limiting (S)
  [INFRA-002] Error Handling (S)
  [INFRA-005] Circuit Breaker (S)

Track B (after FND-002 + AUTH-001):
  [AUTH-002] Google OAuth (M)
  [AUTH-003] User Profile (S)
  [GUEST-001] Guest Sessions (M) → [GUEST-002] Migration (M)

Track C (after AI-001):
  [AI-002] Priority Override (S)
  [AI-003] Reasoning Retrieval (S)
  [PLAN-002] Plan Slot Override (M)

Track D (after FND-002):
  [INFRA-003] Logging/Audit (S)
  [INFRA-004] Job Queue (M)
  [TEST-001] Test Infrastructure (M)

INTEGRATION POINTS
══════════════════
[WS-001] WebSocket Server (needs: FND-001, AUTH-001)
[WS-002] Event Broadcasting (needs: WS-001, TASK-001, PLAN-001)
[TEST-002] Task Tests (needs: TEST-001, TASK-001, TASK-002)
[TEST-003] Auth/Plan Tests (needs: TEST-001, AUTH-001, PLAN-001, GUEST-001)
```

---

## Implicit Tasks (auto-detected)

| Category | Task | Rationale |
|----------|------|-----------|
| Database | Indexes on tasks(user_id, status), tasks(deadline), daily_plans(user_id, date) | Query performance for list/filter operations |
| Database | Soft delete on tasks and users | PRD mentions "archive" and data recovery |
| Database | Cascade delete daily_plan_slots when plan deleted | Parent-child integrity |
| Error Handling | Circuit breaker for OpenAI API | External API dependency — prevent cascade failures |
| Error Handling | Timeout handling on all OpenAI calls (5s) | Prevent hanging requests |
| Error Handling | Retry logic for AI enrichment (3x exponential) | Transient OpenAI failures |
| Security | Rate limiting on auth endpoints (5/min) | Prevent brute force |
| Security | Rate limiting on guest creation (3/hour/IP) | Prevent abuse |
| Security | Input validation via zod on all endpoints | Prevent injection attacks |
| Observability | Audit log for sensitive operations | Track account changes, deletions, migrations |
| Observability | Structured request logging with correlation IDs | Debugging and monitoring |

All implicit tasks are incorporated into the task cards above (not separate tasks).

---

## PRD Ambiguity Defaults Applied

| Area | PRD Ambiguity | Default Applied |
|------|---------------|-----------------|
| Delete strategy | Not specified | Soft delete for tasks and users (deleted_at column) |
| Pagination | "Show tasks" | Cursor-based, 25 per page, ordered by priority_score desc |
| Timestamps | Not mentioned | All tables have created_at, updated_at (auto-managed by Prisma) |
| Task status | "Complete, archive" | Enum: active, completed, archived |
| Error format | Not specified | RFC 7807 Problem Details JSON |
| Daily plan limit | Not specified | Maximum 10 tasks per plan (cognitive load research) |
| UUID vs integer IDs | Not specified | UUID v4 for all primary keys (no sequential enumeration) |
| AI model | "OpenAI SDK" | GPT-4o-mini for parsing, GPT-4o for prioritization/planning |
| Token expiry | "JWT tokens" | Access: 1 hour, Refresh: 7 days (httpOnly cookie) |
| Guest expiry | "7 days" | 7-day TTL, expired sessions cleaned daily by cron job |

---

## Validation Summary

### Coverage
- [x] All 7 user stories from PRD mapped to backend tasks
- [x] All CRUD operations covered for tasks, plans, users
- [x] Error handling for all 3 OpenAI integration points
- [x] Auth/authz tasks for JWT, OAuth, guest sessions
- [x] Audit logging for sensitive operations
- [x] Test tasks for all feature areas

### Structure
- [x] No task exceeds L size (no XXL tasks)
- [x] Each task has 4-6 testable acceptance criteria
- [x] Dependencies explicitly documented
- [x] All tasks have size estimates
- [x] Each task assignable to a single developer

### Technical
- [x] Migration task specifies full schema with types and constraints
- [x] Index strategy documented for queried fields
- [x] Idempotency stated for all mutation endpoints
- [x] Error scenarios listed per external integration
- [x] Queue configuration specified for async work
- [x] Circuit breaker pattern for OpenAI dependency

---

## Export: Jira CSV

```csv
Summary,Description,Issue Type,Priority,Story Points,Epic,Labels
"[FND-001] Project Scaffold and Fastify Server Setup","Fastify v5 + TypeScript project initialization",Task,High,3,"Jaanify MVP","backend,setup"
"[FND-002] Prisma Schema and Database Migrations","Complete database schema for all entities",Task,High,5,"Jaanify MVP","backend,database"
"[AUTH-001] JWT Authentication Plugin","JWT auth with refresh tokens",Task,High,3,"Jaanify MVP","backend,auth"
"[AUTH-002] Google OAuth2 Integration","Google OAuth2 login flow",Task,High,3,"Jaanify MVP","backend,auth"
"[AUTH-003] User Profile and Preferences","Profile and preferences endpoints",Task,Medium,2,"Jaanify MVP","backend,api"
"[TASK-001] Task CRUD Routes","Core task CRUD with ownership enforcement",Task,High,3,"Jaanify MVP","backend,api"
"[TASK-002] NLP Task Parsing Endpoint","OpenAI-powered NLP parsing with fallback",Task,High,3,"Jaanify MVP","backend,ai"
"[TASK-003] Task Labels Management","Label CRUD for tasks",Task,Low,1,"Jaanify MVP","backend,api"
"[AI-001] Task Prioritization Service","AI prioritization with rule-based fallback",Task,High,5,"Jaanify MVP","backend,ai"
"[AI-002] Priority Override with Feedback","Override priority with structured feedback",Task,Medium,2,"Jaanify MVP","backend,ai"
"[AI-003] Reasoning Data Retrieval","Full reasoning data for Tier 2/3 cards",Task,Medium,1,"Jaanify MVP","backend,api"
"[PLAN-001] Daily Plan Generation","AI daily plan with slot reasoning",Task,High,5,"Jaanify MVP","backend,ai"
"[PLAN-002] Plan Slot Override and Completion","Reorder/complete/skip plan slots",Task,Medium,3,"Jaanify MVP","backend,api"
"[GUEST-001] Guest Session Management","Anonymous guest sessions with 7-day expiry",Task,High,3,"Jaanify MVP","backend,auth"
"[GUEST-002] Guest-to-User Migration","Atomic data transfer from guest to user",Task,Medium,3,"Jaanify MVP","backend,auth"
"[WS-001] WebSocket Server Setup","Socket.io with JWT auth and user rooms",Task,Medium,3,"Jaanify MVP","backend,realtime"
"[WS-002] Real-Time Event Broadcasting","Broadcast task/plan events to connected clients",Task,Medium,2,"Jaanify MVP","backend,realtime"
"[INFRA-001] Rate Limiting Plugin","Redis-backed rate limiting per route category",Task,Medium,1,"Jaanify MVP","backend,infra"
"[INFRA-002] Error Handling and RFC 7807 Responses","Global error handler with Problem Details",Task,High,2,"Jaanify MVP","backend,infra"
"[INFRA-003] Request Logging and Audit Trail","Structured logging and audit events",Task,Medium,2,"Jaanify MVP","backend,infra"
"[INFRA-004] BullMQ Job Queue Setup","Background job processing with Redis",Task,Medium,3,"Jaanify MVP","backend,infra"
"[INFRA-005] OpenAI Circuit Breaker Service","Circuit breaker pattern for OpenAI calls",Task,High,2,"Jaanify MVP","backend,infra"
"[TEST-001] Test Infrastructure and Factories","Vitest setup with factories and auth helpers",Task,Medium,3,"Jaanify MVP","backend,testing"
"[TEST-002] Integration Tests — Task CRUD and NLP","Tests for task endpoints and NLP parsing",Task,Medium,3,"Jaanify MVP","backend,testing"
"[TEST-003] Integration Tests — Auth Plan and Guest","Tests for auth, plan, and guest flows",Task,Medium,3,"Jaanify MVP","backend,testing"
```

---

## Export: Linear Markdown

- [ ] [FND-001] Project Scaffold and Fastify Server Setup (M, 3-5h) `backend` `setup` `P0`
- [ ] [FND-002] Prisma Schema and Database Migrations (L, 5-8h, blocked-by: FND-001) `backend` `database` `P0`
- [ ] [AUTH-001] JWT Authentication Plugin (M, 3-5h, blocked-by: FND-001, FND-002) `backend` `auth` `P0`
- [ ] [AUTH-002] Google OAuth2 Integration (M, 3-5h, blocked-by: AUTH-001) `backend` `auth` `P0`
- [ ] [AUTH-003] User Profile and Preferences (S, 2-3h, blocked-by: AUTH-001) `backend` `api` `P1`
- [ ] [TASK-001] Task CRUD Routes (M, 3-5h, blocked-by: FND-002, AUTH-001) `backend` `api` `P0`
- [ ] [TASK-002] NLP Task Parsing Endpoint (M, 3-5h, blocked-by: TASK-001) `backend` `ai` `P0`
- [ ] [TASK-003] Task Labels Management (S, 1-2h, blocked-by: TASK-001) `backend` `api` `P2`
- [ ] [AI-001] Task Prioritization Service (L, 5-8h, blocked-by: TASK-001) `backend` `ai` `P0`
- [ ] [AI-002] Priority Override with Feedback (S, 2-3h, blocked-by: AI-001) `backend` `ai` `P1`
- [ ] [AI-003] Reasoning Data Retrieval (S, 1-2h, blocked-by: AI-001) `backend` `api` `P1`
- [ ] [PLAN-001] Daily Plan Generation (L, 5-8h, blocked-by: AI-001) `backend` `ai` `P0`
- [ ] [PLAN-002] Plan Slot Override and Completion (M, 2-4h, blocked-by: PLAN-001) `backend` `api` `P1`
- [ ] [GUEST-001] Guest Session Management (M, 3-5h, blocked-by: FND-002, AUTH-001) `backend` `auth` `P0`
- [ ] [GUEST-002] Guest-to-User Migration (M, 3-5h, blocked-by: GUEST-001, AUTH-002) `backend` `auth` `P1`
- [ ] [WS-001] WebSocket Server Setup (M, 3-5h, blocked-by: FND-001, AUTH-001) `backend` `realtime` `P1`
- [ ] [WS-002] Real-Time Event Broadcasting (S, 2-3h, blocked-by: WS-001, TASK-001, PLAN-001) `backend` `realtime` `P1`
- [ ] [INFRA-001] Rate Limiting Plugin (S, 1-2h, blocked-by: FND-001) `backend` `infra` `P1`
- [ ] [INFRA-002] Error Handling and RFC 7807 Responses (S, 2-3h, blocked-by: FND-001) `backend` `infra` `P0`
- [ ] [INFRA-003] Request Logging and Audit Trail (S, 2-3h, blocked-by: FND-002) `backend` `infra` `P1`
- [ ] [INFRA-004] BullMQ Job Queue Setup (M, 3-5h, blocked-by: FND-001, GUEST-001) `backend` `infra` `P1`
- [ ] [INFRA-005] OpenAI Circuit Breaker Service (S, 2-3h, blocked-by: FND-001) `backend` `infra` `P0`
- [ ] [TEST-001] Test Infrastructure and Factories (M, 3-5h, blocked-by: FND-002) `backend` `testing` `P1`
- [ ] [TEST-002] Integration Tests — Task CRUD and NLP (M, 3-5h, blocked-by: TEST-001, TASK-001) `backend` `testing` `P1`
- [ ] [TEST-003] Integration Tests — Auth Plan and Guest (M, 3-5h, blocked-by: TEST-001, AUTH-001, PLAN-001) `backend` `testing` `P1`

---

## Definition of Ready

- [x] All tasks have size estimates and priority
- [x] Dependencies explicitly documented with blocked-by notation
- [x] Acceptance criteria are testable (3-6 per task)
- [x] File paths specified for every task
- [x] Error scenarios documented for integration points
- [x] Idempotency requirements stated for mutations
- [x] Security checklists on API tasks

## Definition of Done (per task)

- [ ] Code implements all acceptance criteria
- [ ] Unit/integration tests pass (>=80% coverage)
- [ ] Error scenarios handled per task card
- [ ] Security checklist items verified
- [ ] Code reviewed
- [ ] Deployed to staging

---

> Generated by jaan.to dev-be-task-breakdown | 2026-02-07
