# Jaanify MVP — Infrastructure Scaffold

> Generated by jaan.to | 2026-02-11
> Skill: devops-infra-scaffold

---

## Executive Summary

Complete CI/CD and infrastructure scaffold for Jaanify MVP monorepo (Turborepo + pnpm). Includes GitHub Actions CI (lint, type-check, test with PostgreSQL/Redis service containers, build, Trivy security scan) and CD (Docker image build + push to ghcr.io, Prisma migration, Railway backend deploy, Vercel frontend deploy, smoke tests). Multi-stage Dockerfiles for API (Fastify v5, ~150MB) and Web (Next.js 15 standalone, ~120MB). Docker Compose with PostgreSQL 16, Redis 7, hot-reload dev environment with profiles. Environment config for dev/test/production with secret management guidance.

---

## Metadata

| Field | Value |
|-------|-------|
| Created | 2026-02-11 |
| Skill | devops-infra-scaffold |
| jaan-to Version | v6.0.0 (SHA: 736820e) |
| Output Path | jaan-to/outputs/devops/infra-scaffold/01-jaanify-mvp/ |
| Tech Stack | Node.js 22 + Fastify v5 + Next.js 15 + Prisma v6 + pnpm 9 + Turborepo |
| CI/CD Platform | GitHub Actions |
| Container Registry | GitHub Container Registry (ghcr.io) |
| Deploy Backend | Railway |
| Deploy Frontend | Vercel |
| Environments | development, test, production |

---

## File Inventory

| File | Purpose |
|------|---------|
| ci/ci.yml | CI workflow: lint, type-check, test, build, security scan |
| ci/cd.yml | CD workflow: Docker build, migrate, deploy, smoke test |
| docker/Dockerfile.api | Multi-stage Fastify backend (deps → build → runtime) |
| docker/Dockerfile.web | Multi-stage Next.js frontend (deps → build → runtime) |
| docker/docker-compose.yml | Full-stack dev environment with PostgreSQL + Redis |
| docker/docker-compose.prod.yml | Production overrides (resource limits, restart policy) |
| docker/.dockerignore | Build context exclusions (node_modules, .env, .git) |
| config/.env.example | All env vars with safe defaults and generation commands |
| config/.env.test | Test environment (CI + local test runs) |
| config/.env.production.example | Production template (no secrets, only non-secret config) |
| deploy/railway.toml | Railway backend deployment config |
| deploy/vercel.json | Vercel frontend deployment config |
| deploy/migration.sh | Prisma migration script (deploy/status/reset) |

---

## CI Pipeline Stages

| Stage | Trigger | Duration (est.) | Dependencies |
|-------|---------|-----------------|--------------|
| detect-changes | All | ~10s | dorny/paths-filter |
| lint | API or Web changed | ~30s | pnpm cache |
| test-api | API changed | ~60s | PostgreSQL 16, Redis 7 |
| test-web | Web changed | ~30s | — |
| build | After lint + test pass | ~45s | Turbo cache |
| security | API or Web changed | ~30s | Trivy |

**Total estimated CI time**: ~2-3 minutes (parallel jobs)

## CD Pipeline Stages

| Stage | Trigger | Dependencies |
|-------|---------|--------------|
| build-api-image | Push to main | Docker BuildKit, ghcr.io |
| migrate | After image build | DATABASE_URL secret |
| deploy-api | After migration | RAILWAY_TOKEN secret |
| deploy-web | After migration | VERCEL_TOKEN secret |
| smoke-test | After both deploys | Health endpoints |

---

## Docker Image Targets

| Image | Base | Estimated Size | Non-root |
|-------|------|----------------|----------|
| jaanify-api | node:22-alpine | ~150MB | fastify (UID 1001) |
| jaanify-web | node:22-alpine | ~120MB | nextjs (UID 1001) |

---

## Environment Variables

| Variable | Required | Default | Secret |
|----------|----------|---------|--------|
| DATABASE_URL | Yes | postgresql://...localhost/jaanify | Yes (prod) |
| REDIS_URL | Optional (dev) | redis://localhost:6379 | Yes (prod) |
| NODE_ENV | Yes | development | No |
| PORT | Yes | 3000 | No |
| HOST | Yes | 0.0.0.0 | No |
| LOG_LEVEL | No | info | No |
| CORS_ORIGIN | Yes | http://localhost:3001 | No |
| JWT_SECRET | Yes | — | Yes |
| JWT_EXPIRES_IN | No | 1h | No |
| REFRESH_TOKEN_SECRET | Yes | — | Yes |
| REFRESH_TOKEN_EXPIRES_IN | No | 7d | No |
| GOOGLE_CLIENT_ID | Yes | — | Yes |
| GOOGLE_CLIENT_SECRET | Yes | — | Yes |
| OPENAI_API_KEY | Yes | — | Yes |
| NEXT_PUBLIC_API_URL | Yes | http://localhost:3000 | No |

**Total**: 16 variables (7 secrets, 9 non-secret config)

---

## Docker Compose Services

| Service | Image | Port | Healthcheck | Profile |
|---------|-------|------|-------------|---------|
| postgres | postgres:16-alpine | 5432 | pg_isready | backend, full, default |
| redis | redis:7-alpine | 6379 | redis-cli ping | backend, full, default |
| api | Dockerfile.api (deps) | 3000 | /v1/health | backend, full |
| web | Dockerfile.web (deps) | 3001 | / | frontend, full |

---

## Security Measures

- GitHub Actions pinned by SHA-less version tags (v3, v4, v5) — upgrade to SHA pinning for supply chain security
- Non-root users in all Docker runtime stages
- .dockerignore excludes .env files, .git, node_modules
- .env.production.example contains NO actual secrets
- Trivy filesystem scan in CI (CRITICAL + HIGH severity gate)
- pnpm audit in CI (high severity gate)
- Docker BuildKit cache (no layer leaks)
- HEALTHCHECK in both Dockerfiles
- `--frozen-lockfile` for reproducible installs
