# Jaanify — Scheduled Health Check & Alerting
# Runs every 15 minutes, creates GitHub issue if API or Web is down
# Auto-closes incident when services recover

name: Health Check

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    env:
      API_URL: ${{ vars.API_URL }}
      WEB_URL: ${{ vars.WEB_URL }}
    steps:
      - name: Check API Health
        id: api
        if: env.API_URL != ''
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${API_URL}/v1/health" || echo "000")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          if [ "$STATUS" = "200" ]; then
            echo "API is healthy (HTTP $STATUS)"
          else
            echo "API is DOWN (HTTP $STATUS)"
          fi

      - name: Check Web Health
        id: web
        if: env.WEB_URL != ''
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${WEB_URL}" || echo "000")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "308" ]; then
            echo "Web is healthy (HTTP $STATUS)"
          else
            echo "Web is DOWN (HTTP $STATUS)"
          fi

      - name: Alert on failure
        if: |
          (env.API_URL != '' && steps.api.outputs.status != '200') ||
          (env.WEB_URL != '' && steps.web.outputs.status != '200' && steps.web.outputs.status != '308')
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const apiStatus = '${{ steps.api.outputs.status }}' || 'skipped';
            const webStatus = '${{ steps.web.outputs.status }}' || 'skipped';
            const apiDown = apiStatus !== '200' && apiStatus !== 'skipped';
            const webDown = !['200', '308', 'skipped'].includes(webStatus);

            // Deduplicate: check for existing open incident
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'incident',
              state: 'open',
              per_page: 1
            });

            if (issues.length > 0) {
              // Add comment to existing incident instead of creating duplicate
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `**Health check still failing** (${new Date().toISOString()})\n\n| Service | Status |\n|---------|--------|\n| API | ${apiDown ? 'DOWN ' + apiStatus : 'OK ' + apiStatus} |\n| Web | ${webDown ? 'DOWN ' + webStatus : 'OK ' + webStatus} |`
              });
              return;
            }

            // Create new incident issue
            const services = [];
            if (apiDown) services.push(`API (HTTP ${apiStatus})`);
            if (webDown) services.push(`Web (HTTP ${webStatus})`);

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Service down: ${services.join(', ')} — ${new Date().toISOString().split('T')[0]}`,
              body: `## Incident Report\n\n**Detected at**: ${new Date().toISOString()}\n\n| Service | URL | Status |\n|---------|-----|--------|\n| API | \`${{ vars.API_URL }}/v1/health\` | ${apiDown ? 'DOWN HTTP ' + apiStatus : 'OK HTTP ' + apiStatus} |\n| Web | \`${{ vars.WEB_URL }}\` | ${webDown ? 'DOWN HTTP ' + webStatus : 'OK HTTP ' + webStatus} |\n\n## Triage Steps\n\n1. Check [Railway Dashboard](https://railway.app) for API service status\n2. Check [Vercel Dashboard](https://vercel.com) for Web deployment status\n3. Check recent commits for breaking changes\n4. Review CD workflow runs for deployment failures\n\n## Resolution\n\nClose this issue when services are restored.\n\n---\n> Auto-generated by health-check workflow`,
              labels: ['incident']
            });

      - name: Auto-close resolved incidents
        if: |
          (env.API_URL == '' || steps.api.outputs.status == '200') &&
          (env.WEB_URL == '' || steps.web.outputs.status == '200' || steps.web.outputs.status == '308')
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'incident',
              state: 'open',
              per_page: 5
            });

            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `All services healthy — auto-closing at ${new Date().toISOString()}\n\n| Service | Status |\n|---------|--------|\n| API | OK ${{ steps.api.outputs.status }} |\n| Web | OK ${{ steps.web.outputs.status }} |`
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
