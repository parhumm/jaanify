---
name: gaps-critical-issue
description: Convert gap analysis into GitHub issue requests via jaan-issue-report. Run after /gaps-critical-doc.
allowed-tools: Read, Glob, Grep, Bash(git *), Edit(gap-reports/**), Edit(.claude/skills/gaps-critical-issue/*), Edit(jaan-to/config/settings.yaml)
argument-hint: "<gap-report-path> [--priorities p0,p1]"
user-invocable: true
---

# gaps-critical-issue

> Parse gap reports, filter by priority, and delegate issue creation to `/jaan-issue-report`. Always run after `/gaps-critical-doc`.

## Context Files

Read these before execution:
- `.claude/skills/gaps-critical-issue/LEARN.md` - Past lessons from issue creation
- `CLAUDE.md` - Project rules

**Input source**: Gap reports generated by `/gaps-critical-doc`, located at `gap-reports/{N}-cycle/{N}-launch-gaps.md`.

## Input

**Arguments**: $ARGUMENTS

Parse from arguments:
1. **Gap report path** — file path like `gap-reports/04-cycle/04-launch-gaps.md`, or a cycle number (e.g., `4`)
2. **--priorities** — comma-separated priority levels to include (default: `p0,p1`)

If no arguments provided, auto-detect the latest gap report by globbing `gap-reports/*-cycle/*-launch-gaps.md` and selecting the most recent.

---

# PHASE 1: Analysis (Read-Only)

## Pre-Execution: Apply Past Lessons

**MANDATORY FIRST ACTION** — Read `.claude/skills/gaps-critical-issue/LEARN.md` if it exists and apply its lessons.

### Language Settings

**Read language preference** from `jaan-to/config/settings.yaml`:

1. Check for per-skill override: `language_gaps-critical-issue` field
2. If no override, use the global `language` field

**CRITICAL LANGUAGE RULE:**
- **Conversation** (questions, confirmations, HARD STOP): Use the resolved language preference
- **Issue content**: Handled by `jaan-issue-report --submit` (always English)

## Step 1: Parse Input

1. If argument is a file path → validate it exists with Read tool
2. If argument is a number → resolve to `gap-reports/{N}-cycle/{N}-launch-gaps.md`
3. If no argument → glob `gap-reports/*-cycle/*-launch-gaps.md`, pick the latest by modification time
4. If no gap report found → error: "No gap report found. Run `/gaps-critical-doc` first to generate one."

Parse `--priorities` flag. Default: `p0,p1`. Valid values: `p0`, `p1`, `p2`, `p3` (comma-separated).

## Step 2: Read Gap Report

Read the full gap report file. Extract:

### From YAML Frontmatter
- `cycle` — cycle number
- `jaan_to_version` — jaan-to version
- `gap_summary` — total gaps, per-priority counts, skills needed
- `progress` — specification/scaffold/production/tests percentages

### From Markdown Body (Section B)
For each gap:
- **Gap ID**: `L-{NN}` format
- **Priority**: P0 / P1 / P2 / P3
- **Title**: Gap title
- **Description**: What the gap is
- **Blocks**: What this gap prevents
- **Expected outputs**: Deliverables needed

## Step 3: Filter by Priority

Keep only gaps matching the selected priority levels (default: P0 + P1).

Count:
- Total gaps included
- Gaps per priority level

---

# HARD STOP — Confirmation

Present the filtered gaps summary in the user's conversation language:

```
GAP ISSUE SUMMARY
─────────────────
Gap report:   {path}
Cycle:        {N}

GAPS TO INCLUDE ({total} gaps):
  P0: {n} — {list of gap titles}
  P1: {n} — {list of gap titles}
  {P2/P3 if selected}
```

> "Create a combined issue for these {N} gaps via `/jaan-issue-report --submit`? [y/n]"

**Do NOT proceed without explicit approval.**

---

# PHASE 2: Invoke `jaan-issue-report --submit`

## Step 4: Compose Description

Build a description from the filtered gaps:

```
YOUR_PROJECT_NAME launch readiness: {N} gaps at {priorities} priority blocking launch.

Gaps:
- L-01: {title} — {description}. Blocks: {blocks}
- L-02: {title} — {description}. Blocks: {blocks}
...

Full gap report: gap-reports/{N}-cycle/{N}-launch-gaps.md
jaan-to version: {version}
```

Include enough detail from each gap (title, description, blocks, expected outputs) so `jaan-issue-report --submit` can generate a complete issue body.

## Step 5: Invoke `jaan-issue-report --submit`

Call:
```
/jaan-issue-report "{composed_description}" --type feature --submit
```

`jaan-issue-report` handles:
- Issue title generation
- Issue body generation (feature template)
- Privacy sanitization
- HARD STOP preview
- GitHub submission
- Local copy saved to `jaan-to/website/jaan-to/jaan-issues/`

Wait for `jaan-issue-report` to complete. Capture:
- The GitHub issue URL
- The local output path in `jaan-to/website/jaan-to/jaan-issues/`

---

# PHASE 3: Update Gap Report

## Step 6: Update Gap Report

After `jaan-issue-report` completes, append a reference section to the existing `gap-reports/{N}-cycle/{N}-launch-gaps.md`:

```markdown

---

## GitHub Issue

- **Issue URL:** {github_issue_url}
- **Issue report:** `{jaan-issues-output-path}`
- **Created by:** `gaps-critical-issue` → `jaan-issue-report`
- **Date:** {YYYY-MM-DD}
- **Priorities included:** {priorities}
- **Gaps included:** {gap_ids}
```

## Step 7: Commit Changes

```bash
git add "gap-reports/{N}-cycle/{N}-launch-gaps.md"
git add ".claude/skills/gaps-critical-issue/LEARN.md"  # only if modified
git commit -m "docs(cycle-{N}): link gap report to GitHub issue

Updated gap report with issue URL from jaan-issue-report.

Co-Authored-By: Claude <noreply@anthropic.com>"
```

## Step 8: Capture Feedback

> "Any feedback on this process? [y/n]"

If yes, append to `.claude/skills/gaps-critical-issue/LEARN.md`.

---

## Definition of Done

- [ ] Gap report parsed and gaps filtered by priority
- [ ] User confirmed gap selection at HARD STOP
- [ ] Description composed from filtered gaps
- [ ] `/jaan-issue-report --submit` invoked successfully
- [ ] Existing gap report updated with issue URL and jaan-issues output path
- [ ] Changes committed to git