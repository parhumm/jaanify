---
name: gaps-critical-issue
description: Convert gap analysis into PM-voiced GitHub issue requests. Run after /gaps-critical-doc.
allowed-tools: Read, Glob, Grep, Bash(gh issue create *), Bash(gh label create *), Write(gap-reports/**), Edit(jaan-to/config/settings.yaml)
argument-hint: "<gap-report-path> [--priorities p0,p1] [--repo owner/repo]"
user-invocable: true
---

# gaps-critical-issue

> Convert launch readiness gap analysis into human-voiced GitHub issue requests. Always run after `/gaps-critical-doc`.

## Context Files

Read these before execution:
- `.claude/skills/gaps-critical-issue/LEARN.md` - Past lessons from issue creation
- `.claude/skills/gaps-critical-issue/template.md` - Issue body tone model
- `CLAUDE.md` - Project rules (contains target repo URL)

**Input source**: Gap reports generated by `/gaps-critical-doc`, located at `gap-reports/{N}-cycle/{N}-launch-gaps.md`.

## Input

**Arguments**: $ARGUMENTS

Parse from arguments:
1. **Gap report path** — file path like `gap-reports/04-cycle/04-launch-gaps.md`, or a cycle number (e.g., `4`)
2. **--priorities** — comma-separated priority levels to include (default: `p0,p1`)
3. **--repo** — target GitHub repo in `owner/repo` format (default: detected from `CLAUDE.md`)

If no arguments provided, auto-detect the latest gap report by globbing `gap-reports/*-cycle/*-launch-gaps.md` and selecting the most recent.

---

# PHASE 1: Analysis (Read-Only)

## Pre-Execution: Apply Past Lessons

**MANDATORY FIRST ACTION** — Before any other step, use the Read tool to read:
`.claude/skills/gaps-critical-issue/LEARN.md`

If the file exists, apply its lessons throughout this execution:
- Follow tone guidance from "Workflow"
- Avoid anti-patterns from "Common Mistakes"
- Check edge cases from "Edge Cases"

If the file does not exist, continue without it.

### Language Settings

**Read language preference** from `jaan-to/config/settings.yaml`:

1. Check for per-skill override: `language_gaps-critical-issue` field
2. If no override, use the global `language` field
3. Resolve:

| Value | Action |
|-------|--------|
| Language code (`en`, `fa`, `tr`, etc.) | Use that language for conversation |
| `"ask"` or field missing | Prompt: "What language do you prefer for conversation?" — then save choice to `jaan-to/config/settings.yaml` |

**CRITICAL LANGUAGE RULE:**
- **Conversation** (questions, confirmations, status messages, HARD STOP prompts): Use the resolved language preference
- **Issue output** (title + body): **ALWAYS in English** regardless of conversation language. This is hardcoded and cannot be overridden. GitHub issues target an English-speaking developer audience.

**Keep in English always**: technical terms, file paths, variable names, gap IDs, skill names, code snippets.

## Thinking Mode

megathink

Use extended reasoning for:
- Translating formal gap-report language into visceral PM voice
- Selecting the most impactful pain points from each gap
- Crafting the opening narrative that connects deliverable inventory to the current blocker

## Step 1: Parse Input

1. If argument is a file path → validate it exists with Read tool
2. If argument is a number → resolve to `gap-reports/{N}-cycle/{N}-launch-gaps.md`
3. If no argument → glob `gap-reports/*-cycle/*-launch-gaps.md`, pick the latest by modification time
4. If no gap report found → error: "No gap report found. Run `/gaps-critical-doc` first to generate one."

Parse `--priorities` flag. Default: `p0,p1`. Valid values: `p0`, `p1`, `p2`, `p3` (comma-separated).

Parse `--repo` flag. If not provided, detect in Step 4.

## Step 2: Read Gap Report

Read the full gap report file. Extract:

### From YAML Frontmatter
- `cycle` — cycle number
- `date` — report date
- `jaan_to_version` — jaan-to version
- `gap_summary.total` — total gap count
- `gap_summary.p0` through `gap_summary.p3` — counts per priority
- `gap_summary.new_skills_needed` — skills to create
- `gap_summary.skill_improvements_needed` — skills to improve
- `progress.specification` through `progress.tests` — progress percentages

### From Markdown Body
For each gap in "Section B — Launch & GTM Gap Analysis":
- **Gap ID**: `L-{NN}` format
- **Priority**: P0 / P1 / P2 / P3 (from the heading it's under)
- **Title**: Gap title
- **What**: Description from the table
- **Exists in jaan-to?**: Skill status
- **Related gaps**: Cross-references
- **Blocks**: What this gap prevents
- **Key points**: Bullet list of critical details
- **Expected outputs**: Bullet list of deliverables

From "Section A — Current State":
- Deliverable count and inventory table
- Implementation progress matrix

From "Section C — Summary Table":
- Quick-reference table for all gaps

From "Section D — Critical Path":
- ASCII dependency diagram

## Step 3: Filter by Priority

Keep only gaps matching the selected priority levels (default: P0 + P1).

Count:
- Total gaps included
- Gaps per priority level
- New skills needed (among included gaps)
- Skill improvements needed (among included gaps)

## Step 4: Detect Target Repo

1. Read `CLAUDE.md` and search for GitHub repo URLs matching `github.com/{owner}/{repo}`
2. Look specifically for the jaan-to repo URL
3. If found, extract `owner/repo` format (e.g., `parhumm/jaan-to`)
4. If `--repo` was provided, use that instead
5. If neither found, ask user for the target repo

## Step 5: Read Project Context

Read the PRD from `$JAAN_OUTPUTS_DIR/pm/prd/` (if it exists) to extract:
- Project name (should be "Jaanify")
- Total feature count
- MVP scope summary
- Key value proposition

Read the deliverable inventory from the gap report's Section A to get:
- Total deliverable count
- Cycle count
- Skill names used

This data feeds the opening paragraph — the "what we've built" narrative.

---

# HARD STOP #1 — Analysis Review

Present the analysis summary in the user's conversation language:

```
ISSUE ANALYSIS
──────────────
Gap report:   {path}
Cycle:        {N}
Target repo:  {owner/repo}

GAPS TO INCLUDE ({total} gaps):
  P0: {n} — {list of gap titles}
  P1: {n} — {list of gap titles}
  {P2/P3 if selected}

SKILLS REQUEST:
  New skills needed:       {n}
  Skill improvements:      {n}

Issue will be written in English.
```

> "Proceed with generating the issue? [y/n]"

**Do NOT proceed to Phase 2 without explicit approval.**

---

# PHASE 2: Generation (Write Phase)

## Step 6: Generate Issue Title

Craft a human-voiced title. **Always in English.**

**Rules:**
- No formal language ("Gap Analysis", "Feature Request", "Skill Inventory")
- Lead with the honest situation, then what you need
- Keep under 80 characters
- Use em dash (—) to separate situation from need

**Pattern**: `{honest situation} — {what we need}`

**Examples from real issues:**
- "We're stuck at 0% production code — need skills to go from scaffold to launch"
- "74 test scenarios but pnpm test crashes — need test generation skill"
- "detect-dev finds vulnerabilities but nothing fixes them — need security hardening"

**How to generate:**
1. Look at the progress matrix — what's the most striking number? (0% production, 0% tests, etc.)
2. Look at the P0 gaps — what's the single biggest blocker?
3. Combine into a sentence a frustrated-but-constructive PM would say

## Step 7: Generate Issue Body

Read the template from `.claude/skills/gaps-critical-issue/template.md` for structural guidance.

**Always write in English.** Generate each section:

### Opening Paragraph

Write 2-3 paragraphs that tell the story:
1. **What we've built**: Reference specific deliverable counts, cycle count, and skill names. Show investment.
2. **The honest truth**: State the gap bluntly. Use bold for the key stat (e.g., "**we're at 100% specification and 0% production code**").
3. **What this issue covers**: "This issue covers the {N} most critical gaps ({priorities}) that are blocking our launch."

**Tone model** (from issue #51):
> "We've been building **Jaanify** (an AI Task Manager) entirely with jaan-to for 4 cycles now. The plugin has been fantastic for specification and scaffolding — we've generated 17 deliverables..."
> "But here's the honest truth: **we're at 100% specification and 0% production code.**"

### Per-Priority Sections

For each priority level being included, add a heading:
- `## P0 — Launch Blockers`
- `## P1 — Security & Deployment (can't go public without these)`
- `## P2 — GTM Essentials`

### Per-Gap Sections

For each gap within a priority level:

```markdown
### {N}. {Human-Readable Title} (Gap L-{NN})

**The pain:** {Rewrite the gap's "What" field as a visceral, specific pain point. Use concrete numbers. Make it feel like something a real PM would complain about in a standup.}

**What we already have (the inputs are all there):**
{List the existing deliverables that serve as inputs for solving this gap. Pull from the gap's "Key points" and the deliverable inventory. Show that the investment has been made — the specs exist, the scaffolds exist, the test scenarios exist.}

**What's missing:** {Describe what skill or improvement would close this gap. Be specific about what it should do. Reference the gap's "Exists in jaan-to?" status.}

**Why it matters:** {Business and launch impact. Not just "it's a blocker" but WHY it blocks. What happens to users, to the product, to trust if this isn't fixed? Pull from the gap's "Blocks" field and amplify.}

**Expected output:**
{Bullet list of concrete deliverables the skill should produce. Pull from the gap's "Expected outputs" field.}
```

**Tone rules for each section:**
- **The pain**: Use "literally", "every single", "crashes immediately", "do nothing", "wide open" — words that convey urgency without being unprofessional
- **What we have**: Use "the inputs are all there", "already exists", "we invested in" — show prior work
- **What's missing**: Be specific about the skill name or improvement. "A skill that..." or "The scaffold should..."
- **Why it matters**: Connect to users, trust, legal, or business outcomes. "This is a legal and trust issue, not just a technical one."
- **Expected output**: Concrete file paths and deliverables. No vague promises.

### Summary Table

```markdown
## Summary

| Priority | Gap | Need | Type |
|----------|-----|------|------|
| **P0** | L-01 | {title} | {New skill / Scaffold improvement} |
...

**{N} new skills needed**, **{M} existing skills need improvement**.

Critical path: {one-sentence dependency chain from gap report}
```

### Footer

```markdown
**Project:** {project_name} — {one-line description}
**Full analysis:** `{gap_report_path}`
**jaan-to version:** {version}
```

---

# HARD STOP #2 — Issue Verification

Show the **complete issue preview** in English:

```
ISSUE PREVIEW
─────────────────────────────────────────
Repo:   {owner/repo}
Title:  {title}
Label:  enhancement

BODY:
─────────────────────────────────────────
{full issue body — every line}
─────────────────────────────────────────
```

Ask in the user's conversation language:
> "Submit this issue to {repo}? [y/n/edit]"

- **y**: Proceed to create issue
- **n**: Abort, no issue created
- **edit**: User provides feedback → revise and show preview again

**Do NOT submit the issue without explicit "y" approval.**

---

## Step 8: Save Local Copy

Write the issue body (plus metadata header) to `gap-reports/{N}-cycle/{N}-issue-report.md`:

```markdown
---
title: "{issue_title}"
issue_url: ""
issue_number: null
repo: "{owner/repo}"
date: "{YYYY-MM-DD}"
source: "gap-reports/{N}-cycle/{N}-launch-gaps.md"
priorities_included: [p0, p1]
gaps_included: [L-01, L-02, ...]
generated_by: "gaps-critical-issue"
---

{full issue body}
```

This ensures a local record exists before any network call. The `issue_url` and `issue_number` fields are populated in Step 10 after successful issue creation.

## Step 9: Create Issue

Run via Bash:
```bash
gh issue create --repo {owner/repo} \
  --title "{title}" \
  --label "enhancement" \
  --body-file "gap-reports/{N}-cycle/{N}-issue-report.md"
```

**Note:** Use `--body-file` pointing to the local copy saved in Step 8 (the frontmatter will be included but is harmless in the issue body). Alternatively, use a separate temp file or `--body` with the body content directly.

Capture the returned issue URL and extract the issue number.

If the command fails (e.g., label doesn't exist), try without `--label` and inform the user.

## Step 9b: Update Local Copy with Issue URL

After successful issue creation, update the frontmatter in `gap-reports/{N}-cycle/{N}-issue-report.md`:
- Set `issue_url` to the returned GitHub URL
- Set `issue_number` to the extracted issue number

## Step 10: Confirm

Show in the user's conversation language:
- Issue URL (clickable)
- Local copy path
- Gap count submitted
- Recommend: "Next steps: monitor the issue for responses, and run `/gaps-critical-doc` again next cycle to track progress."

---

## Step 11: Capture Feedback

> "Any feedback on this issue report? [y/n]"

If yes, append to `.claude/skills/gaps-critical-issue/LEARN.md` under the appropriate section.

---

## Definition of Done

- [ ] Gap report parsed successfully (frontmatter + all gaps extracted)
- [ ] Gaps filtered by selected priorities
- [ ] Target repo detected or provided
- [ ] HARD STOP #1 approved by user
- [ ] Issue title is human-voiced, not formal
- [ ] Issue body follows PM tone model (The pain / What we have / What's missing / Why it matters / Expected output)
- [ ] Issue body is in English regardless of conversation language
- [ ] HARD STOP #2 approved by user (full preview shown)
- [ ] Local copy saved to `gap-reports/{N}-cycle/{N}-issue-report.md`
- [ ] GitHub issue created via `gh issue create`
- [ ] Local copy updated with issue URL and number
- [ ] Issue URL returned and displayed
- [ ] User informed of next steps