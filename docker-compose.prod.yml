# Jaanify â€” Production overrides
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  postgres:
    restart: always
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD}
    deploy:
      resources:
        limits:
          memory: 512M

  redis:
    restart: always
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: 256M

  api:
    build:
      target: runtime # Use optimized runtime stage
    restart: always
    volumes: [] # No bind mounts in production
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:?Set DATABASE_URL}
      REDIS_URL: ${REDIS_URL:?Set REDIS_URL}
      JWT_SECRET: ${JWT_SECRET:?Set JWT_SECRET}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:?Set REFRESH_TOKEN_SECRET}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:?Set GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:?Set GOOGLE_CLIENT_SECRET}
      OPENAI_API_KEY: ${OPENAI_API_KEY:?Set OPENAI_API_KEY}
    deploy:
      resources:
        limits:
          memory: 512M
      restart_policy:
        condition: on-failure
        max_attempts: 3

  web:
    build:
      target: runtime
    restart: always
    volumes: []
    environment:
      NODE_ENV: production
    deploy:
      resources:
        limits:
          memory: 512M
      restart_policy:
        condition: on-failure
        max_attempts: 3
